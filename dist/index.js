var Xe=Object.defineProperty;var Y=(r,s)=>()=>(r&&(s=r(r=0)),s);var ae=(r,s)=>{for(var o in s)Xe(r,o,{get:s[o],enumerable:!0})};var de={};ae(de,{abTestParticipants:()=>tt,abTests:()=>Ae,analyticsEvents:()=>et,conversionFunnels:()=>Ne,favoriteHooks:()=>E,funnelEvents:()=>rt,hookGenerations:()=>f,insertFavoriteHookSchema:()=>le,insertHookGenerationSchema:()=>nt,insertUserRecentHookSchema:()=>it,insertUserSchema:()=>J,loginSchema:()=>ue,registerSchema:()=>ce,sessions:()=>Ze,upsertUserSchema:()=>st,userConsent:()=>ot,userRecentHooks:()=>U,users:()=>c});import{sql as w}from"drizzle-orm";import{pgTable as D,text as I,varchar as m,jsonb as T,timestamp as k,boolean as H,index as p,integer as G,check as R}from"drizzle-orm/pg-core";import{createInsertSchema as z}from"drizzle-zod";import{z as h}from"zod";var Ze,c,f,E,U,et,Ae,tt,Ne,rt,ot,ce,ue,J,st,nt,le,it,Q=Y(()=>{"use strict";Ze=D("sessions",{sid:m("sid").primaryKey(),sess:T("sess").notNull(),expire:k("expire").notNull()},r=>[p("IDX_session_expire").on(r.expire)]),c=D("users",{id:m("id").primaryKey().default(w`gen_random_uuid()`),email:m("email").notNull().unique(),password:m("password"),firebaseUid:m("firebase_uid").unique(),firstName:m("first_name"),lastName:m("last_name"),emailVerified:H("email_verified").default(!1),profileImageUrl:m("profile_image_url"),company:I("company"),industry:I("industry"),role:I("role"),audience:I("audience"),voice:I("voice"),bannedTerms:T("banned_terms").$type().default([]),safety:I("safety").default("standard"),proGenerationsUsed:G("pro_generations_used").default(0),draftGenerationsUsed:G("draft_generations_used").default(0),weeklyDraftReset:k("weekly_draft_reset").defaultNow(),freeCredits:G("free_credits").default(5),usedCredits:G("used_credits").default(0),isPremium:H("is_premium").default(!1),stripeCustomerId:m("stripe_customer_id"),stripeSubscriptionId:m("stripe_subscription_id"),subscriptionStatus:m("subscription_status").default("free"),subscriptionPlan:m("subscription_plan").default("free"),currentPeriodEnd:k("current_period_end"),cancelAtPeriodEnd:H("cancel_at_period_end").default(!1),createdAt:k("created_at").defaultNow(),updatedAt:k("updated_at").defaultNow()},r=>[p("idx_users_email").on(r.email),p("idx_users_firebase_uid").on(r.firebaseUid),p("idx_users_stripe_customer_id").on(r.stripeCustomerId),p("idx_users_created_at").on(r.createdAt),p("idx_users_subscription_status").on(r.subscriptionStatus),R("email_format",w`${r.email} ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'`),R("safety_values",w`${r.safety} IN ('family-friendly', 'standard', 'edgy')`),R("subscription_status_values",w`${r.subscriptionStatus} IN ('free', 'active', 'canceled', 'past_due', 'trialing', 'unpaid')`),R("subscription_plan_values",w`${r.subscriptionPlan} IN ('free', 'starter', 'creator', 'pro', 'teams')`),R("positive_generations",w`${r.proGenerationsUsed} >= 0 AND ${r.draftGenerationsUsed} >= 0`),R("positive_credits",w`${r.freeCredits} >= 0 AND ${r.usedCredits} >= 0`)]),f=D("hook_generations",{id:m("id").primaryKey().default(w`gen_random_uuid()`),userId:m("user_id").notNull().references(()=>c.id,{onDelete:"cascade"}),platform:I("platform").notNull(),objective:I("objective").notNull(),topic:I("topic").notNull(),modelType:I("model_type").notNull().default("gpt-4o"),hooks:T("hooks").$type().notNull(),topThreeVariants:T("top_three_variants").$type(),createdAt:k("created_at").defaultNow()},r=>[p("idx_hook_generations_user_id").on(r.userId),p("idx_hook_generations_created_at").on(r.createdAt),p("idx_hook_generations_platform").on(r.platform),p("idx_hook_generations_user_platform").on(r.userId,r.platform),p("idx_hook_generations_user_created").on(r.userId,r.createdAt),R("platform_values",w`${r.platform} IN ('tiktok', 'instagram', 'youtube', 'twitter', 'linkedin')`),R("objective_values",w`${r.objective} IN ('watch_time', 'shares', 'saves', 'ctr', 'engagement', 'conversions')`),R("model_type_values",w`${r.modelType} IN ('gpt-4o', 'gpt-4o-mini')`)]),E=D("favorite_hooks",{id:m("id").primaryKey().default(w`gen_random_uuid()`),userId:m("user_id").notNull().references(()=>c.id,{onDelete:"cascade"}),generationId:m("generation_id").references(()=>f.id,{onDelete:"set null"}),hook:I("hook"),hookData:T("hook_data").$type(),framework:I("framework").notNull(),platformNotes:I("platform_notes").notNull(),topic:I("topic"),platform:I("platform"),createdAt:k("created_at").defaultNow()},r=>[p("idx_favorite_hooks_user_id").on(r.userId),p("idx_favorite_hooks_created_at").on(r.createdAt),p("idx_favorite_hooks_user_created").on(r.userId,r.createdAt),p("idx_favorite_hooks_generation_id").on(r.generationId),p("idx_favorite_hooks_unique_user_generation").on(r.userId,r.generationId)]),U=D("user_recent_hooks",{id:m("id").primaryKey().default(w`gen_random_uuid()`),userId:m("user_id").notNull().references(()=>c.id,{onDelete:"cascade"}),hook:I("hook").notNull(),createdAt:k("created_at").defaultNow()},r=>[p("idx_user_recent_hooks_user_id").on(r.userId),p("idx_user_recent_hooks_created_at").on(r.createdAt),p("idx_user_recent_hooks_user_created").on(r.userId,r.createdAt)]),et=D("analytics_events",{id:m("id").primaryKey().default(w`gen_random_uuid()`),sessionId:m("session_id").notNull(),userId:m("user_id").references(()=>c.id,{onDelete:"set null"}),eventType:m("event_type").notNull(),eventData:T("event_data").$type().notNull().default({}),deviceInfo:T("device_info").$type().notNull(),pageInfo:T("page_info").$type().notNull(),ipAddress:m("ip_address"),userConsent:H("user_consent").default(!1),createdAt:k("created_at").defaultNow()},r=>[p("idx_analytics_events_session_id").on(r.sessionId),p("idx_analytics_events_user_id").on(r.userId),p("idx_analytics_events_event_type").on(r.eventType),p("idx_analytics_events_created_at").on(r.createdAt),p("idx_analytics_events_user_event_type").on(r.userId,r.eventType),p("idx_analytics_events_session_created").on(r.sessionId,r.createdAt),R("event_type_values",w`${r.eventType} IN ('cta_click', 'cta_view', 'cta_hover', 'trust_signal_view', 'urgency_indicator_view', 'funnel_step', 'ab_test_exposure', 'error', 'performance', 'page_view', 'user_identified', 'session_reset', 'conversion')`)]),Ae=D("ab_tests",{id:m("id").primaryKey().default(w`gen_random_uuid()`),testName:m("test_name").notNull(),testDescription:I("test_description"),status:m("status").notNull().default("draft"),variants:T("variants").$type().notNull(),trafficAllocation:G("traffic_allocation").notNull().default(100),targetingRules:T("targeting_rules").$type(),minSampleSize:G("min_sample_size").default(100),significanceLevel:G("significance_level").default(95),primaryMetric:m("primary_metric").default("conversion_rate"),startDate:k("start_date"),endDate:k("end_date"),winnerVariant:m("winner_variant"),createdBy:m("created_by").references(()=>c.id,{onDelete:"set null"}),createdAt:k("created_at").defaultNow(),updatedAt:k("updated_at").defaultNow()},r=>[p("idx_ab_tests_status").on(r.status),p("idx_ab_tests_created_at").on(r.createdAt),p("idx_ab_tests_start_end_date").on(r.startDate,r.endDate),R("status_values",w`${r.status} IN ('draft', 'running', 'paused', 'completed', 'archived')`),R("traffic_allocation_range",w`${r.trafficAllocation} >= 0 AND ${r.trafficAllocation} <= 100`),R("significance_level_range",w`${r.significanceLevel} >= 90 AND ${r.significanceLevel} <= 99`)]),tt=D("ab_test_participants",{id:m("id").primaryKey().default(w`gen_random_uuid()`),testId:m("test_id").notNull().references(()=>Ae.id,{onDelete:"cascade"}),sessionId:m("session_id").notNull(),userId:m("user_id").references(()=>c.id,{onDelete:"set null"}),variantId:m("variant_id").notNull(),exposureTime:k("exposure_time").defaultNow(),converted:H("converted").default(!1),conversionTime:k("conversion_time"),conversionValue:G("conversion_value").default(0),metadata:T("metadata").$type().default({}),createdAt:k("created_at").defaultNow()},r=>[p("idx_ab_test_participants_test_id").on(r.testId),p("idx_ab_test_participants_session_id").on(r.sessionId),p("idx_ab_test_participants_user_id").on(r.userId),p("idx_ab_test_participants_variant_id").on(r.variantId),p("idx_ab_test_participants_test_variant").on(r.testId,r.variantId),p("idx_ab_test_participants_converted").on(r.converted),p("idx_ab_test_participants_unique").on(r.testId,r.sessionId)]),Ne=D("conversion_funnels",{id:m("id").primaryKey().default(w`gen_random_uuid()`),funnelName:m("funnel_name").notNull(),funnelDescription:I("funnel_description"),steps:T("steps").$type().notNull(),isActive:H("is_active").default(!0),createdBy:m("created_by").references(()=>c.id,{onDelete:"set null"}),createdAt:k("created_at").defaultNow(),updatedAt:k("updated_at").defaultNow()},r=>[p("idx_conversion_funnels_active").on(r.isActive),p("idx_conversion_funnels_created_at").on(r.createdAt),p("idx_conversion_funnels_name").on(r.funnelName)]),rt=D("funnel_events",{id:m("id").primaryKey().default(w`gen_random_uuid()`),funnelId:m("funnel_id").notNull().references(()=>Ne.id,{onDelete:"cascade"}),sessionId:m("session_id").notNull(),userId:m("user_id").references(()=>c.id,{onDelete:"set null"}),stepIndex:G("step_index").notNull(),stepName:m("step_name").notNull(),previousStep:m("previous_step"),timeFromPrevious:G("time_from_previous"),abandoned:H("abandoned").default(!1),completed:H("completed").default(!1),eventData:T("event_data").$type().default({}),createdAt:k("created_at").defaultNow()},r=>[p("idx_funnel_events_funnel_id").on(r.funnelId),p("idx_funnel_events_session_id").on(r.sessionId),p("idx_funnel_events_user_id").on(r.userId),p("idx_funnel_events_step_index").on(r.stepIndex),p("idx_funnel_events_funnel_session").on(r.funnelId,r.sessionId),p("idx_funnel_events_completed").on(r.completed),p("idx_funnel_events_abandoned").on(r.abandoned)]),ot=D("user_consent",{id:m("id").primaryKey().default(w`gen_random_uuid()`),sessionId:m("session_id").notNull(),userId:m("user_id").references(()=>c.id,{onDelete:"cascade"}),analyticsConsent:H("analytics_consent").default(!1),marketingConsent:H("marketing_consent").default(!1),personalizationConsent:H("personalization_consent").default(!1),consentVersion:m("consent_version").notNull().default("1.0"),ipAddress:m("ip_address"),userAgent:I("user_agent"),consentMethod:m("consent_method").default("explicit"),withdrawnAt:k("withdrawn_at"),createdAt:k("created_at").defaultNow(),updatedAt:k("updated_at").defaultNow()},r=>[p("idx_user_consent_session_id").on(r.sessionId),p("idx_user_consent_user_id").on(r.userId),p("idx_user_consent_analytics").on(r.analyticsConsent),p("idx_user_consent_created_at").on(r.createdAt),R("consent_method_values",w`${r.consentMethod} IN ('explicit', 'implicit', 'essential')`)]),ce=h.object({email:h.string().email("Please enter a valid email address"),password:h.string().min(6,"Password must be at least 6 characters"),firstName:h.string().min(1,"First name is required"),lastName:h.string().min(1,"Last name is required")}),ue=h.object({email:h.string().email("Please enter a valid email address"),password:h.string().min(1,"Password is required")}),J=z(c).omit({id:!0,password:!0,createdAt:!0,updatedAt:!0}).extend({platforms:h.array(h.string()).optional(),goals:h.array(h.string()).optional(),examples:h.string().optional()}),st=z(c).pick({id:!0,email:!0,firstName:!0,lastName:!0,profileImageUrl:!0}),nt=z(f).omit({id:!0,createdAt:!0}),le=h.object({userId:h.string(),hook:h.string().optional(),generationId:h.string().optional(),framework:h.string(),platformNotes:h.string(),topic:h.string().optional(),platform:h.string().optional(),hookData:h.object({verbalHook:h.string(),visualHook:h.string().optional(),textualHook:h.string().optional(),framework:h.string(),psychologicalDriver:h.string().optional(),hookCategory:h.string().optional(),score:h.number().optional(),scoreBreakdown:h.string().optional(),rationale:h.string().optional(),platformNotes:h.string().optional(),platformSpecific:h.object({tiktokColdOpen:h.string().optional(),instagramOverlay:h.string().optional(),youtubeProofCue:h.string().optional()}).optional()}).optional()}),it=z(U).omit({id:!0,createdAt:!0})});var ee={};ae(ee,{db:()=>y,initializeDatabase:()=>dt,pool:()=>F,testDatabaseConnection:()=>Re});import{Pool as at,neonConfig as Pe}from"@neondatabase/serverless";import{drizzle as ct}from"drizzle-orm/neon-serverless";import ut from"ws";async function Re(r=1e4){try{let s=F.query("SELECT 1 as health, NOW() as current_time, version() as db_version"),o=new Promise((t,n)=>setTimeout(()=>n(new Error(`Database connection timeout after ${r}ms`)),r)),e=await Promise.race([s,o]);return{success:!0,connectionInfo:{version:e.rows[0]?.db_version?.split(" ")[0]||"unknown",time:e.rows[0]?.current_time,poolStats:{totalCount:F.totalCount,idleCount:F.idleCount,waitingCount:F.waitingCount}}}}catch(s){return{success:!1,error:s instanceof Error?s.message:String(s)}}}async function dt(){for(let o=1;o<=5;o++)try{console.log(`Database connection attempt ${o}/5...`);let e=await Re(15e3);if(e.success){console.log("\u2705 Database connection established successfully"),console.log(`Database version: ${e.connectionInfo?.version}`);return}else throw new Error(e.error)}catch(e){if(console.log(`\u274C Database connection attempt ${o} failed:`,e instanceof Error?e.message:String(e)),o===5)throw console.error("\u{1F6A8} Failed to establish database connection after all retries"),e;console.log("\u23F3 Retrying in 2000ms..."),await new Promise(t=>setTimeout(t,2e3))}}var Z,lt,X,F,y,q=Y(()=>{"use strict";Q();Pe.webSocketConstructor=ut;process.env.RAILWAY_ENVIRONMENT&&(Pe.wsProxy=r=>(r.includes("railway.internal")&&console.log(`Connecting to Railway internal database: ${r}`),`${r}`));if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");Z=new URL(process.env.DATABASE_URL);if(Z.protocol!=="postgresql:"&&Z.protocol!=="postgres:")throw new Error("DATABASE_URL must use postgresql:// protocol");Z.searchParams.has("sslmode")||Z.searchParams.set("sslmode","require");lt=!!process.env.RAILWAY_ENVIRONMENT,X=process.env.DATABASE_URL?.includes("railway.internal"),F=new at({connectionString:process.env.DATABASE_URL,max:15,min:lt?2:1,idleTimeoutMillis:6e4,connectionTimeoutMillis:X?3e4:1e4,statementTimeout:3e4,query_timeout:3e4,acquireTimeoutMillis:X?45e3:15e3,createTimeoutMillis:X?3e4:1e4,destroyTimeoutMillis:5e3,reapIntervalMillis:5e3,createRetryIntervalMillis:X?3e3:1e3,propagateCreateError:!0,allowExitOnIdle:!1,maxUses:1e4,application_name:`hooklinestudio-${process.env.RAILWAY_ENVIRONMENT||"local"}`,ssl:{rejectUnauthorized:!1}}),y=ct({client:F,schema:de})});var Te={};ae(Te,{SUBSCRIPTION_PLANS:()=>te,cancelSubscription:()=>ge,createBillingPortalSession:()=>pe,createSubscription:()=>me,getOrCreateCustomer:()=>xe,getSubscriptionStatus:()=>fe,handleStripeWebhook:()=>he});import mt from"stripe";async function xe(r,s,o){try{let e=await g.getUser(r);if(e?.stripeCustomerId)return e.stripeCustomerId;let t=await O.customers.create({email:s,name:o||s,metadata:{userId:r}});return await g.updateStripeCustomerId(r,t.id),t.id}catch(e){throw console.error("Error creating/retrieving customer:",e),e}}async function me(r,s,o,e){try{let t=await xe(r,s),n={customer:t,items:[{price:o}],payment_behavior:"default_incomplete",payment_settings:{save_default_payment_method:"on_subscription"},expand:["latest_invoice.payment_intent"],trial_period_days:7};e&&(n.discounts=[{coupon:e}]);let i=await O.subscriptions.create(n);return await g.updateUserStripeInfo(r,{stripeCustomerId:t,stripeSubscriptionId:i.id}),{subscriptionId:i.id,clientSecret:i.latest_invoice&&typeof i.latest_invoice=="object"?i.latest_invoice.payment_intent?.client_secret:null,customerId:t}}catch(t){throw console.error("Error creating subscription:",t),t}}async function pe(r,s){try{return(await O.billingPortal.sessions.create({customer:r,return_url:s})).url}catch(o){throw console.error("Error creating billing portal session:",o),o}}async function fe(r){try{let s=await O.subscriptions.retrieve(r);return{status:s.status,currentPeriodEnd:new Date(s.current_period_end*1e3),cancelAtPeriodEnd:s.cancel_at_period_end,trialEnd:s.trial_end}}catch(s){throw console.error("Error getting subscription status:",s),s}}async function ge(r){try{return await O.subscriptions.update(r,{cancel_at_period_end:!0})}catch(s){throw console.error("Error canceling subscription:",s),s}}async function he(r){try{switch(r.type){case"invoice.payment_succeeded":let s=r.data.object;if(s.subscription){let a=await O.subscriptions.retrieve(s.subscription),u=await O.customers.retrieve(a.customer);u.metadata?.userId&&await g.updateUser(u.metadata.userId,{subscriptionStatus:"active",currentPeriodEnd:new Date(a.current_period_end*1e3),cancelAtPeriodEnd:a.cancel_at_period_end})}break;case"invoice.payment_failed":let o=r.data.object;if(o.subscription){let a=await O.subscriptions.retrieve(o.subscription),u=await O.customers.retrieve(a.customer);u.metadata?.userId&&await g.updateUser(u.metadata.userId,{subscriptionStatus:"past_due"})}break;case"customer.subscription.deleted":let e=r.data.object,t=await O.customers.retrieve(e.customer);t.metadata?.userId&&await g.updateUser(t.metadata.userId,{subscriptionStatus:"canceled",subscriptionPlan:"free",stripeSubscriptionId:null,cancelAtPeriodEnd:!1});break;case"customer.subscription.updated":let n=r.data.object,i=await O.customers.retrieve(n.customer);i.metadata?.userId&&await g.updateUser(i.metadata.userId,{subscriptionStatus:n.status,currentPeriodEnd:new Date(n.current_period_end*1e3),cancelAtPeriodEnd:n.cancel_at_period_end});break;default:console.log(`Unhandled event type: ${r.type}`)}}catch(s){throw console.error("Error handling webhook:",s),s}}var O,te,ye=Y(()=>{"use strict";re();if(!process.env.STRIPE_SECRET_KEY)throw new Error("Missing required Stripe secret: STRIPE_SECRET_KEY");O=new mt(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-06-30.basil"}),te={FREE:{name:"Free",priceId:null,amount:0,currency:"usd",interval:"month",features:["20 Draft generations per week (GPT-4o-mini)","Basic scoring insights","Community support"],limits:{draftGenerationsPerWeek:20,draftGenerationsPerMonth:-1,proGenerationsPerMonth:0,exports:!1,priority:!1,modelType:"gpt-4o-mini"}},STARTER:{name:"Starter",priceId:process.env.STRIPE_STARTER_PRICE_ID||"price_starter_placeholder",amount:9,currency:"usd",interval:"month",features:["100 Pro generations per month (GPT-4o)","Unlimited Draft generations (GPT-4o-mini)","Cancel anytime"],limits:{proGenerationsPerMonth:100,draftGenerationsPerMonth:-1,exports:!1,priority:!1,overageRate:3,modelType:"both"}},CREATOR:{name:"Creator",priceId:process.env.STRIPE_CREATOR_PRICE_ID||"price_creator_placeholder",amount:15,currency:"usd",interval:"month",features:["200 Pro generations per month (GPT-4o)","Unlimited Draft generations (GPT-4o-mini)","Cold-open exports"],limits:{proGenerationsPerMonth:200,draftGenerationsPerMonth:-1,exports:!0,coldOpenExports:!0,priority:!1,overageRate:3,modelType:"both"}},PRO:{name:"Pro",priceId:process.env.STRIPE_PRO_PRICE_ID||"price_pro_placeholder",amount:24,currency:"usd",interval:"month",features:["400 Pro generations per month (GPT-4o)","Unlimited Draft generations (GPT-4o-mini)","Sheets/CSV export","Advanced analytics"],limits:{proGenerationsPerMonth:400,draftGenerationsPerMonth:-1,exports:!0,sheetsExport:!0,analytics:!0,priority:!1,overageRate:2.5,modelType:"both"}},TEAMS:{name:"Teams",priceId:process.env.STRIPE_TEAMS_PRICE_ID||"price_teams_placeholder",amount:59,currency:"usd",interval:"month",features:["1,500 Pro generations pooled per month","3 seats included","Shared style guide","Priority support"],limits:{proGenerationsPerMonth:1500,draftGenerationsPerMonth:-1,exports:!0,teamSeats:3,sharedStyleGuide:!0,priority:!0,overageRate:2.5,modelType:"both"}}}});import{eq as v,desc as L,inArray as pt,and as ft,gte as gt,lte as ht,sql as oe}from"drizzle-orm";var _e,g,re=Y(()=>{"use strict";Q();q();_e=class{async getUser(s){let[o]=await y.select().from(c).where(v(c.id,s));return o||void 0}async getUserByEmail(s){let[o]=await y.select().from(c).where(v(c.email,s));return o||void 0}async getUserByUsername(s){let[o]=await y.select().from(c).where(v(c.company,s));return o||void 0}async getUserByFirebaseUid(s){let[o]=await y.select().from(c).where(v(c.firebaseUid,s));return o||void 0}async createUser(s){let[o]=await y.insert(c).values(s).returning();return o}async createUserFromFirebase(s){let[o]=await y.insert(c).values({...s,password:null}).returning();return o}async updateUser(s,o){let[e]=await y.update(c).set({...o,bannedTerms:o.bannedTerms?o.bannedTerms:void 0,updatedAt:new Date}).where(v(c.id,s)).returning();return e||void 0}async upsertUser(s){let o;if(s.email&&(o=await this.getUserByEmail(s.email)),!o&&s.firebaseUid&&(o=await this.getUserByFirebaseUid(s.firebaseUid)),o)return this.updateUser(o.id,s);{let[e]=await y.insert(c).values(s).returning();return e}}async incrementUserCredits(s){let o=await this.getUser(s);if(!o)return;let t=(o.usedCredits||0)+1;return this.updateUser(s,{usedCredits:t})}async checkUserCanGenerate(s){let o=await this.getUser(s);if(!o)return{canGenerate:!1,remainingCredits:0,isAtLimit:!0};if(o.isPremium)return{canGenerate:!0,remainingCredits:999,isAtLimit:!1};let e=o.freeCredits||5,t=o.usedCredits||0,n=Math.max(0,e-t),i=n===0;return{canGenerate:n>0,remainingCredits:n,isAtLimit:i}}async incrementUserGenerations(s,o){let e=await this.getUser(s);if(e)if(o==="gpt-4o"){let t=e.proGenerationsUsed||0;return this.updateUser(s,{proGenerationsUsed:t+1})}else{let t=e.draftGenerationsUsed||0;return this.updateUser(s,{draftGenerationsUsed:t+1})}}async checkUserCanGenerateWithModel(s,o){let e=await this.getUser(s);if(!e)return{canGenerate:!1,reason:"User not found",remainingProGenerations:0,remainingDraftGenerations:0,planLimits:null};let t=e.subscriptionPlan||"free",{SUBSCRIPTION_PLANS:n}=await Promise.resolve().then(()=>(ye(),Te)),i=t.toUpperCase(),a=n[i]?.limits;if(!a)return{canGenerate:!1,reason:"Invalid subscription plan",remainingProGenerations:0,remainingDraftGenerations:0,planLimits:null};let u=e.proGenerationsUsed||0,l=e.draftGenerationsUsed||0,_=0,S=0;if(t==="free"){let C=new Date(e.weeklyDraftReset||e.createdAt||new Date);Math.floor((Date.now()-C.getTime())/(10080*60*1e3))>=1?(await this.updateUser(s,{draftGenerationsUsed:0,weeklyDraftReset:new Date}),S=20):S=Math.max(0,20-l),_=0}else a.proGenerationsPerMonth===-1?_=999:_=Math.max(0,a.proGenerationsPerMonth-u),a.draftGenerationsPerMonth===-1?S=999:S=Math.max(0,a.draftGenerationsPerMonth-l);let A=!1,P;return o==="gpt-4o"?t==="free"?(A=!1,P="Pro generations require a paid subscription"):(A=_>0,A||(P=`Pro generation limit reached (${a.proGenerationsPerMonth}/month)`)):t==="free"?(A=S>0,A||(P="Weekly draft generation limit reached (20/week)")):(A=S>0,A||(P="Draft generation limit reached")),{canGenerate:A,reason:P,remainingProGenerations:_,remainingDraftGenerations:S,planLimits:a}}async resetUserGenerationCounts(s){return this.updateUser(s,{proGenerationsUsed:0,draftGenerationsUsed:0,weeklyDraftReset:new Date})}async createHookGeneration(s){let[o]=await y.insert(f).values({...s,hooks:s.hooks,topThreeVariants:s.topThreeVariants}).returning();return o}async getHookGenerationsByUser(s){return await y.select().from(f).where(v(f.userId,s)).orderBy(L(f.createdAt))}async getGenerationsByUserId(s){return this.getHookGenerationsByUser(s)}async getGenerationById(s){let[o]=await y.select().from(f).where(v(f.id,s));return o||null}async deleteGeneration(s){return((await y.delete(f).where(v(f.id,s))).rowCount??0)>0}async getHookGeneration(s){let[o]=await y.select().from(f).where(v(f.id,s));return o||void 0}async createFavoriteHook(s){let[o]=await y.insert(E).values(s).returning();return o}async getFavoriteHooksByUser(s){return await y.select().from(E).where(v(E.userId,s)).orderBy(L(E.createdAt))}async deleteFavoriteHook(s){try{return await y.delete(E).where(v(E.id,s)),!0}catch{return!1}}async addRecentHook(s){let[o]=await y.insert(U).values(s).returning();return await this.cleanupOldRecentHooks(s.userId),o}async getRecentHooksByUser(s){return await y.select().from(U).where(v(U.userId,s)).orderBy(L(U.createdAt)).limit(10)}async cleanupOldRecentHooks(s){let o=await y.select().from(U).where(v(U.userId,s)).orderBy(L(U.createdAt));if(o.length>10){let e=o.slice(10);for(let t of e)await y.delete(U).where(v(U.id,t.id))}}async resetUserCredits(s){let[o]=await y.update(c).set({usedCredits:0,updatedAt:new Date}).where(v(c.id,s)).returning();return o||void 0}async updateStripeCustomerId(s,o){try{let[e]=await y.update(c).set({stripeCustomerId:o}).where(v(c.id,s)).returning();return e||null}catch(e){throw console.error("Error updating stripe customer ID:",e),e}}async updateUserStripeInfo(s,o){try{let[e]=await y.update(c).set({stripeCustomerId:o.stripeCustomerId,stripeSubscriptionId:o.stripeSubscriptionId,isPremium:!0}).where(v(c.id,s)).returning();return e||null}catch(e){throw console.error("Error updating user stripe info:",e),e}}async updateUserSubscriptionStatus(s,o){try{let[e]=await y.update(c).set({isPremium:o.status==="active",updatedAt:new Date}).where(v(c.id,s)).returning();return e||null}catch(e){throw console.error("Error updating user subscription status:",e),e}}async getUserByStripeCustomerId(s){try{let[o]=await y.select().from(c).where(v(c.stripeCustomerId,s)).limit(1);return o||null}catch(o){throw console.error("Error finding user by stripe customer ID:",o),o}}async getUsersWithGenerationsCount(s){return s.length===0?[]:await y.select({id:c.id,email:c.email,firstName:c.firstName,lastName:c.lastName,company:c.company,subscriptionPlan:c.subscriptionPlan,subscriptionStatus:c.subscriptionStatus,createdAt:c.createdAt,generationsCount:oe`COUNT(${f.id})::int`.as("generations_count")}).from(c).leftJoin(f,v(c.id,f.userId)).where(pt(c.id,s)).groupBy(c.id).orderBy(L(c.createdAt))}async getHookGenerationsWithUserData(s,o=50){return await y.select({id:f.id,userId:f.userId,platform:f.platform,objective:f.objective,topic:f.topic,modelType:f.modelType,hooks:f.hooks,topThreeVariants:f.topThreeVariants,createdAt:f.createdAt,user:{id:c.id,email:c.email,firstName:c.firstName,lastName:c.lastName,company:c.company,subscriptionPlan:c.subscriptionPlan,subscriptionStatus:c.subscriptionStatus}}).from(f).innerJoin(c,v(f.userId,c.id)).where(v(f.userId,s)).orderBy(L(f.createdAt)).limit(o)}async getFavoriteHooksWithUserAndGenerationData(s){return await y.select({id:E.id,userId:E.userId,generationId:E.generationId,hook:E.hook,hookData:E.hookData,framework:E.framework,platformNotes:E.platformNotes,topic:E.topic,platform:E.platform,createdAt:E.createdAt,user:{id:c.id,email:c.email,firstName:c.firstName,lastName:c.lastName,company:c.company},generation:{id:f.id,platform:f.platform,topic:f.topic,modelType:f.modelType,createdAt:f.createdAt}}).from(E).innerJoin(c,v(E.userId,c.id)).leftJoin(f,v(E.generationId,f.id)).where(v(E.userId,s)).orderBy(L(E.createdAt))}async getPopularHooksAnalytics(s,o){let e=y.select({platform:f.platform,totalGenerations:oe`COUNT(*)::int`.as("total_generations"),avgScore:oe`AVG((hooks::jsonb->0->>'score')::numeric)::float`.as("avg_score")}).from(f);return s&&o&&(e=e.where(ft(gt(f.createdAt,s),ht(f.createdAt,o)))),await e.groupBy(f.platform).orderBy(L(oe`COUNT(*)`))}lastHealthCheck=null;async healthCheck(){let s=Date.now();if(this.lastHealthCheck&&s-this.lastHealthCheck.timestamp<3e4)return this.lastHealthCheck.result;try{return await y.select().from(c).limit(1),this.lastHealthCheck={result:!0,timestamp:s},!0}catch(o){throw console.error("Database health check failed:",o),this.lastHealthCheck={result:!1,timestamp:s},o}}},g=new _e});import Se from"express";re();Q();import xt from"express";import{createServer as Tt}from"http";import yt from"openai";if(!process.env.OPENAI_API_KEY&&!process.env.API_KEY)throw new Error("OPENAI_API_KEY or API_KEY environment variable is required");var ke=new yt({apiKey:process.env.OPENAI_API_KEY||process.env.API_KEY}),_t={"Question-Based":{"QH-01":{formula:"Direct Question",driver:"Curiosity Gap / Engagement",template:"Did you know that {surprising_fact}?",risk:"low",examples:["Did you know that squats can fix back pain?","Did you know perfect form takes 30 seconds?"]},"QH-02":{formula:"Rhetorical Question",driver:"Pain Point / Empathy",template:"Does your {area_of_life} feel {negative_adjective}?",risk:"low",examples:["Does your squat feel unstable?","Are your workouts feeling ineffective?"]},"QH-03":{formula:"Hypothetical 'What If'",driver:"Imagination / Desire",template:"What if {ideal_scenario}?",risk:"medium",examples:["What if perfect form was actually easier?","What if one cue fixed everything?"]},"QH-04":{formula:"High-Stakes Question",driver:"Intrigue / Moral Dilemma",template:"Would you {action_a} for {benefit} but {consequence}?",risk:"medium",examples:["Would you change your form if it prevented injury?","Would you slow down to speed up progress?"]},"QH-05":{formula:"Challenge Question",driver:"Authority / Knowledge Gap",template:"Why do {authority_figures} still {questionable_action}?",risk:"medium",examples:["Why do trainers still teach this wrong?","Why does everyone skip this step?"]}},"Statement-Based":{"ST-01":{formula:"Direct Promise",driver:"Value / Instant Gratification",template:"In this video, I'm going to show/tell you {specific_value}.",risk:"low",examples:["I'm going to show you perfect squat form","I'll teach you the one cue that fixes everything"]},"ST-02":{formula:"Startling Fact / Statistic",driver:"Surprise / Authority",template:"{percentage}% of people {surprising_behavior}.",risk:"medium",examples:["90% of people squat with poor form","Most trainers miss this critical detail"]},"ST-03":{formula:"Contrarian / Unpopular Opinion",driver:"Social Proof (Negative) / Intrigue",template:"{common_belief} is wrong. Here's why.",risk:"high",examples:["Deep squats are wrong. Here's why.","Heavy weight is overrated. Here's why."]},"ST-04":{formula:"Common Mistake ID",driver:"Pain Point / Superiority",template:"You've been doing {common_activity} wrong your entire life.",risk:"medium",examples:["You've been squatting wrong your entire life","Everyone gets this form cue backwards"]},"ST-05":{formula:"Authority Insight",driver:"Credibility / Exclusivity",template:"{expert_type} taught me this {technique}",risk:"low",examples:["Olympic coaches taught me this squat cue","Physical therapists use this form check"]}},Narrative:{"NA-01":{formula:"In Medias Res",driver:"Curiosity Gap / Urgency",template:"Starts mid-action or mid-dialogue at a point of high drama.",risk:"medium",examples:["The moment my form clicked...","Right when I thought I knew squats..."]},"NA-02":{formula:"Cliffhanger / Open Loop",driver:"Curiosity Gap",template:"This {event} ended in the most shocking way. Stay tuned...",risk:"high",examples:["This form correction changed everything...","What happened next surprised even me..."]},"NA-03":{formula:"Personal Confession / Anecdote",driver:"Empathy / Relatability",template:"I used to {old_behavior}, until {catalyst_for_change}.",risk:"low",examples:["I used to hate squats, until I learned this","I thought perfect form was impossible, until..."]},"NA-04":{formula:"Before & After Teaser",driver:"Curiosity Gap / Transformation",template:"This is how I went from {before_state} to {after_state}.",risk:"low",examples:["From knee pain to pain-free squats","From sloppy form to perfect technique"]},"NA-05":{formula:"Timeline Progression",driver:"Journey / Progress",template:"Day {number} of {challenge}",risk:"low",examples:["Day 7 of fixing my squat form","30 days of perfect form practice"]}},"Urgency/Exclusivity":{"UE-01":{formula:"Direct Callout / Targeting",driver:"Personalization / Relevance",template:"If you're a {target_audience}, you need to hear this.",risk:"medium",examples:["If you squat, you need to hear this","If you're serious about form, watch this"]},"UE-02":{formula:"FOMO / Time Pressure",driver:"Urgency",template:"This is your last chance to {action} before {consequence}.",risk:"high",examples:["Last chance to fix your form before injury","Don't wait until it's too late"]},"UE-03":{formula:"The 'Secret' Reveal",driver:"Curiosity Gap / Exclusivity",template:"No one is telling you the real reason {common_problem_persists}.",risk:"medium",examples:["No one tells you why squats feel awkward","The real reason your form breaks down"]},"UE-04":{formula:"Warning / Preemptive Advice",driver:"Urgency / Pain Avoidance",template:"Watch this before you {common_action}.",risk:"medium",examples:["Watch this before your next squat session","See this before you add more weight"]},"UE-05":{formula:"Insider Access",driver:"Exclusivity / Authority",template:"What {authority_figures} don't want you to know",risk:"high",examples:["What trainers don't teach about form","What gyms don't want you to know"]}},Efficiency:{"EF-01":{formula:"Numbered List (Listicle)",driver:"Value / Structure",template:"Here are the Top {number} {items} for {goal}.",risk:"low",examples:["Top 3 squat cues for perfect form","5 form checks that prevent injury"]},"EF-02":{formula:"Quick Solution / 'Hack'",driver:"Value / Instant Gratification",template:"How to {achieve_goal} in {short_timeframe}.",risk:"low",examples:["Perfect squats in 30 seconds","Fix your form in one video"]},"EF-03":{formula:"Shortcut Reveal",driver:"Efficiency / Simplification",template:"Skip {complex_method}, do this instead",risk:"medium",examples:["Skip complex cues, do this instead","Skip the textbook, watch this"]},"EF-04":{formula:"Elimination Strategy",driver:"Focus / Simplification",template:"Stop {wrong_action}, start {right_action}",risk:"low",examples:["Stop thinking about depth, focus on this","Stop following trends, master basics"]}}};function vt(r,s){return r==="educational"?["Statement-Based","Efficiency","Question-Based"]:r==="storytelling"?["Narrative","Question-Based","Urgency/Exclusivity"]:["Statement-Based","Narrative","Question-Based"]}function wt(r){let s=r.flatMap(o=>{let e=_t[o];return e?Object.entries(e).slice(0,2).map(([t,n])=>({id:t,formula:n.formula,template:n.template,examples:n.examples?.slice(0,2)||[]})):[]});return JSON.stringify(s,null,2)}var we={tiktok:{wordRange:[8,12],overlayMax:null,requiresElement:"visual_cold_open"},instagram:{wordRange:[6,15],overlayMax:24,requiresElement:"overlay"},youtube:{wordRange:[4,8],overlayMax:null,requiresElement:"proof_cue"}};function Et(r,s){let o=[],e=(r.verbalHook||"").trim().split(/\s+/).length,t=we[s],[n,i]=t.wordRange;return(e<n||e>i)&&o.push(`Word count ${e} outside ${s} range ${n}-${i}`),/^(if you|stop scrolling|did you know|here's|this is|watch this)/i.test(r.verbalHook||"")&&o.push("Contains overused opening phrase"),s==="instagram"&&r.textualHook&&r.textualHook.length>24&&o.push("Instagram overlay text exceeds 24 characters"),{valid:o.length===0,issues:o,wordCount:e}}async function kt(r,s,o){console.log(`Repairing hook with issues: ${o.join(", ")}`);let e=`Fix this hook for ${s}:
Current hook: "${r.verbalHook}"
Issues: ${o.join(", ")}

Requirements:
- ${s==="tiktok"?"8-12 words":s==="instagram"?"6-15 words":"4-8 words"}
- Avoid clich\xE9d openings (if you, stop scrolling, did you know, here's, this is)
- Keep the same framework and rationale
- Make it engaging and platform-optimized

Return only the improved verbal hook text.`;try{let n=(await ke.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"user",content:e}],temperature:.4,max_tokens:100})).choices[0].message.content?.trim();n&&(r.verbalHook=n,r.wordCount=n.split(/\s+/).length)}catch(t){console.error("Hook repair failed:",t)}return r}function Ue(r,s){let o=["how to","tutorial","learn","guide","tips","technique"],e=["story","journey","experience","transformation","challenge"],t=r.toLowerCase(),n=s.toLowerCase(),i=o.some(u=>t.includes(u)||n.includes(u)),a=e.some(u=>t.includes(u)||n.includes(u));return i&&!a?"educational":a&&!i?"storytelling":"mixed"}async function Ee(r,s){let o=(r.verbalHook||"").trim().split(/\s+/).length,e=s.platform,t=2.5,n=0;e==="tiktok"?n=Math.exp(-Math.pow(o-10,2)/8):e==="instagram"?n=Math.exp(-Math.pow(o-10,2)/(2*2.5*2.5)):e==="youtube"&&(n=Math.exp(-Math.pow(o-6,2)/(2*1.5*1.5)));let a={"Open Loop":.8,"Problem-Promise-Proof":.7,"4U's":.6,AIDA:.5,PAS:.5,Direct:.3,Statement:.4,Question:.5}[r.framework]||.4,u=0;e==="tiktok"&&s.objective==="watch_time"?u=r.framework==="Open Loop"?.6:.3:e==="instagram"&&s.objective==="saves"?u=r.framework==="Problem-Promise-Proof"?.5:.2:e==="youtube"&&s.objective==="ctr"&&(u=r.framework==="Question"?.4:.2);let l=Math.min(5,t+n*1.2+a+u+(Math.random()*.3-.15)),_=Math.round(l*10)/10,S=`Word Count: ${Math.round(n*10)/10}, Framework: ${a}, Platform: ${Math.round(u*10)/10} = ${_}/5`;return{...r,wordCount:o,score:_,scoreBreakdown:S,psychologicalDriver:r.psychologicalDriver||"Engagement",hookCategory:r.hookCategory||"Statement-Based",riskFactor:"low",platformNotes:`Optimized for ${s.platform} ${s.objective}`,contentTypeStrategy:Ue(s.topic,s.objective),promiseContentMatch:!0,specificityScore:.7+Math.random()*.2,freshnessScore:.6+Math.random()*.3}}function bt(r){return r.sort((o,e)=>(e.score||0)-(o.score||0)).slice(0,3).map((o,e)=>({...o,variantType:["enhanced","refined","optimized"][e],originalScore:o.score}))}async function Ce(r){console.log("Starting streamlined tri-modal generation with params:",r);let{topic:s,platform:o,objective:e,user:t}=r,n=Ue(s,e),i=vt(n,e),a=wt(i);console.log("Selected taxonomy categories:",i);let u=`You are HookBot, an expert viral video strategist. Generate engaging tri-modal hooks (verbal + visual + textual) optimized for ${o} ${e}.

FOCUS: Generate hooks with minimal fields to ensure reliable JSON parsing.
QUALITY: Use proven psychological frameworks and avoid clich\xE9d openings.
PLATFORM: Optimize for ${o} engagement patterns and constraints.`,l=`### GENERATION REQUEST ###
TOPIC: "${s}"
PLATFORM: ${o} 
OBJECTIVE: ${e}
CONTENT STRATEGY: ${n}

### BRAND CONTEXT ###
Company: ${t.company||"Content Creator"}
Industry: ${t.industry||"General"}
Audience: ${t.audience||"General audience"}
Voice: ${t.voice||"Professional"}

### ALLOWED HOOK CATEGORIES ###
Use only these proven categories and templates:
${a}

### OUTPUT FORMAT ###
Return exactly this JSON structure with 10 hooks:
{
  "hooks": [
    {
      "verbalHook": "Spoken opening line (${we[o].wordRange[0]}-${we[o].wordRange[1]} words)",
      "visualHook": "First frame visual suggestion",
      "textualHook": "On-screen text overlay",
      "framework": "Copywriting framework used",
      "rationale": "Why this hook works for the audience"
    }
  ]
}

Generate 10 hooks using diverse frameworks from the allowed categories. Avoid clich\xE9d openings like "If you", "Stop scrolling", "Did you know".`;try{let _=new AbortController,S=setTimeout(()=>{console.log("Generation timed out after 25 seconds"),_.abort()},25e3),A=await ke.chat.completions.create({model:"gpt-4o",messages:[{role:"system",content:u},{role:"user",content:l}],response_format:{type:"json_object"},temperature:.8,max_tokens:2500},{signal:_.signal});clearTimeout(S);let P=A.choices[0].message.content;if(!P)throw new Error("No content from streamlined generation");let C=P.trim();C.startsWith("```json")&&(C=C.replace(/^```json\s*/,"").replace(/\s*```$/,"")),C=C.replace(/,(\s*[}\]])/g,"$1");let V;try{V=JSON.parse(C)}catch{return console.error("JSON parsing failed, attempting fallback generation"),await ve(r)}if(!V.hooks||!Array.isArray(V.hooks))return console.error("Invalid hook structure, attempting fallback"),await ve(r);let W=[];for(let K of V.hooks.slice(0,10)){let ie=Et(K,o);if(!ie.valid&&ie.issues.length>0){let Qe=await kt(K,o,ie.issues);W.push(await Ee(Qe,r))}else W.push(await Ee(K,r))}let Je=bt(W);return console.log(`Successfully generated ${W.length} validated hooks`),{hooks:W,topThreeVariants:Je}}catch(_){return console.error("Streamlined generation failed:",_),await ve(r)}}async function ve(r){console.log("Using fallback generation");let s=`Generate 10 simple hooks for ${r.platform} about "${r.topic}":
Mix of: Direct value hooks, Question hooks, Transformation hooks, Statement hooks

JSON format: {"hooks": [{"verbalHook": "text", "visualHook": "visual", "textualHook": "overlay", "framework": "Direct", "rationale": "why"}]}`;try{let e=(await ke.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"user",content:s}],response_format:{type:"json_object"},temperature:.5,max_tokens:1e3})).choices[0].message.content;if(e){let t=JSON.parse(e),n=[];for(let i of t.hooks||[])n.push(await Ee(i,r));return{hooks:n,topThreeVariants:[]}}}catch(o){console.error("Fallback generation failed:",o)}return It(r)}function It(r){return console.log("Using static fallback generation"),{hooks:[{hook:"Here's what you need to know about this",framework:"Direct"},{hook:"This might surprise you about form",framework:"Open Loop"},{hook:"Most people get this wrong",framework:"Statement"},{hook:"Why does everyone struggle with this",framework:"Question"},{hook:"The secret to perfect form",framework:"Statement"},{hook:"Before you try this exercise",framework:"Warning"},{hook:"Transform your workout with this",framework:"Transformation"},{hook:"Nobody talks about this mistake",framework:"Contrarian"},{hook:"Professional trainers use this technique",framework:"Authority"},{hook:"Stop making this common error",framework:"Problem"}].map((e,t)=>({verbalHook:e.hook,visualHook:"Show clear demonstration of the concept",textualHook:"Quick Tutorial",framework:e.framework,psychologicalDriver:"Value",hookCategory:"Statement-Based",riskFactor:"low",score:3+Math.random()*1.5,wordCount:e.hook.split(" ").length,scoreBreakdown:"Static fallback hook",rationale:"Reliable hook pattern for engagement",platformNotes:"Platform-optimized for engagement",contentTypeStrategy:"value_hit",promiseContentMatch:!0,specificityScore:.7,freshnessScore:.6})),topThreeVariants:[]}}import{initializeApp as St,cert as At,getApps as He}from"firebase-admin/app";import{getAuth as Nt}from"firebase-admin/auth";if(!He().length&&process.env.FIREBASE_PROJECT_ID)try{console.log("Initializing Firebase Admin SDK..."),process.env.FIREBASE_PROJECT_ID?.includes("@")&&(console.error("ERROR: FIREBASE_PROJECT_ID appears to be a service account email, not a project ID!"),console.error("FIREBASE_PROJECT_ID should be just: hook-line-studio"),console.error("Current value:",process.env.FIREBASE_PROJECT_ID));let r={projectId:process.env.FIREBASE_PROJECT_ID,privateKey:process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g,`
`),clientEmail:process.env.FIREBASE_CLIENT_EMAIL};if(!r.projectId||!r.privateKey||!r.clientEmail)throw new Error("Missing required Firebase credentials");St({credential:At(r)}),console.log("Firebase Admin SDK initialized successfully")}catch(r){throw console.error("Firebase Admin SDK initialization failed:",r),r}var j=He().length>0?Nt():null;async function De(r,s=!1){if(!process.env.FIREBASE_PROJECT_ID||!j)throw new Error("Firebase not configured");try{return await j.verifyIdToken(r,s)}catch(o){throw console.error("Error verifying Firebase token:",o),o}}re();function Pt(r){let s=r.header("authorization")||r.header("Authorization");return s&&s.toLowerCase().startsWith("bearer ")?s.slice(7).trim():r.header("x-firebase-token")?.trim()}async function N(r,s,o){try{let e=Pt(r);if(!e)return s.status(401).json({message:"No authentication token provided"});let t=await De(e);r.firebaseUser={uid:t.uid,email:t.email,email_verified:t.email_verified,name:t.name,picture:t.picture};try{let n=await g.getUserByFirebaseUid(t.uid);n?r.user={id:n.id,email:n.email||t.email||"",firstName:n.firstName,lastName:n.lastName,company:n.company,industry:n.industry,role:n.role,audience:n.audience,voice:n.voice,bannedTerms:n.bannedTerms,freeCredits:n.freeCredits,usedCredits:n.usedCredits,isPremium:n.isPremium}:r.user={id:t.uid,email:t.email||""}}catch(n){console.warn("Could not fetch user from database:",n),r.user={id:t.uid,email:t.email||""}}o()}catch(e){return String(e?.message||"").includes("expired")?s.status(401).json({message:"Authentication token expired"}):s.status(401).json({message:"Invalid authentication token"})}}import Oe from"express-rate-limit";import Rt from"helmet";var Ge=Oe({windowMs:900*1e3,max:100,message:"Too many requests from this IP, please try again later.",standardHeaders:!0,legacyHeaders:!1}),Fe=Oe({windowMs:60*1e3,max:5,message:"Too many hook generation requests, please wait before trying again.",standardHeaders:!0,legacyHeaders:!1}),Le=(r,s,o)=>{if(r.body){let e=n=>typeof n!="string"?n:n.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/javascript:/gi,"").replace(/on\w+\s*=/gi,"").trim(),t=n=>{if(typeof n=="string")return e(n);if(Array.isArray(n))return n.map(t);if(n&&typeof n=="object"){let i={};for(let a in n)i[a]=t(n[a]);return i}return n};r.body=t(r.body)}o()},je=Rt({contentSecurityPolicy:!0,crossOriginEmbedderPolicy:!1,hsts:{maxAge:31536e3,includeSubDomains:!0,preload:!0}}),$e=(r,s,o)=>{let e=r.get("Content-Length");if(e&&parseInt(e)>1048576)return s.status(413).json({error:"Request too large"});o()};ye();import Ut from"stripe";var Ct=new Ut(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-06-30.basil"});async function Be(r){return r.set("trust proxy",1),r.use(je),r.use($e),r.use(Le),r.use("/api/",Ge),r.post("/api/auth/register",async(o,e)=>{try{let t=ce.safeParse(o.body);if(!t.success)return e.status(400).json({message:"Invalid input data",errors:t.error.issues.map(l=>({field:l.path.join("."),message:l.message}))});let{email:n,password:i,firstName:a,lastName:u}=t.data;try{let l=await j.createUser({email:n,password:i,displayName:`${a} ${u}`,emailVerified:!1}),_=await j.createCustomToken(l.uid),S={id:l.uid,email:l.email||n,firstName:a,lastName:u,company:"",industry:"",role:"",audience:"",voice:"",bannedTerms:[],safetyPreferences:{avoidControversy:!0,familyFriendly:!0,brandSafe:!0},freeCredits:5,usedCredits:0,isPremium:!1,subscriptionStatus:"free",subscriptionPlan:null,currentPeriodEnd:null,cancelAtPeriodEnd:!1,stripeCustomerId:null,stripeSubscriptionId:null};try{await g.upsertUser(S)}catch(A){console.log("Database user creation error (possibly duplicate):",A.message)}e.json({success:!0,customToken:_,user:{uid:l.uid,email:l.email,displayName:l.displayName,emailVerified:l.emailVerified}})}catch(l){return console.error("Firebase Admin registration error:",l),l.code==="auth/email-already-exists"?e.status(400).json({message:"An account with this email already exists"}):e.status(400).json({message:"Registration failed: "+l.message})}}catch(t){console.error("Registration error:",t),e.status(500).json({message:"Internal server error during registration"})}}),r.post("/api/auth/login",async(o,e)=>{try{let t=ue.safeParse(o.body);if(!t.success)return e.status(400).json({message:"Invalid input data",errors:t.error.issues.map(a=>({field:a.path.join("."),message:a.message}))});let{email:n,password:i}=t.data;try{let a=await j.getUserByEmail(n),u=await j.createCustomToken(a.uid);e.json({success:!0,customToken:u,user:{uid:a.uid,email:a.email,displayName:a.displayName,emailVerified:a.emailVerified}})}catch(a){return console.error("Firebase Admin login error:",a),a.code==="auth/user-not-found"?e.status(401).json({message:"Invalid email or password"}):e.status(401).json({message:"Login failed: "+a.message})}}catch(t){console.error("Login error:",t),e.status(500).json({message:"Internal server error during login"})}}),r.post("/api/auth/firebase-sync",N,async(o,e)=>{try{let t=o.firebaseUser;if(!t||!t.uid||!t.email)return e.status(401).json({message:"Invalid Firebase authentication"});let n=await g.getUser(t.uid),i=!1;if(n)n=await g.getUser(t.uid);else{i=!0;let u={id:t.uid,email:t.email,firstName:t.name?.split(" ")[0]||"",lastName:t.name?.split(" ").slice(1).join(" ")||"",company:"",industry:"",role:"",audience:"",voice:"",bannedTerms:[],safetyPreferences:{avoidControversy:!0,familyFriendly:!0,brandSafe:!0},freeCredits:5,usedCredits:0,isPremium:!1,subscriptionStatus:"free",subscriptionPlan:null,currentPeriodEnd:null,cancelAtPeriodEnd:!1,stripeCustomerId:null,stripeSubscriptionId:null};n=await g.upsertUser(u)}if(!n)throw new Error("Failed to create or retrieve user");let a=!n.company?.trim()||!n.industry?.trim()||!n.role?.trim()||!n.audience?.trim()||!n.voice?.trim();console.log("Firebase sync check:",{userId:t.uid,company:n.company,industry:n.industry,role:n.role,audience:n.audience,voice:n.voice,needsOnboarding:a}),e.json({success:!0,user:n,isNewUser:i,needsOnboarding:a})}catch(t){console.error("Firebase sync error:",t),e.status(500).json({message:"Failed to sync user data"})}}),r.post("/api/users",N,async(o,e)=>{try{let t=o.firebaseUser?.uid;if(!t)return e.status(401).json({message:"Authentication required"});console.log("Creating/updating user profile for:",t);let n={...o.body,email:o.user?.email||o.firebaseUser?.email||"",id:t},i=J.parse(n),a=await g.updateUser(t,i);if(!a)return e.status(404).json({message:"User not found"});e.json(a)}catch(t){console.error("Error creating/updating user:",t),e.status(400).json({message:"Invalid user data",error:t instanceof Error?t.message:"Unknown error"})}}),r.get("/api/users/me",N,async(o,e)=>{try{let t=o.firebaseUser?.uid;if(!t)return e.status(401).json({message:"Authentication required"});let n=await g.getUser(t);if(!n)return e.status(404).json({message:"User not found"});e.json(n)}catch(t){e.status(500).json({message:"Failed to fetch user",error:t instanceof Error?t.message:"Unknown error"})}}),r.put("/api/users/me",N,async(o,e)=>{try{let t=o.firebaseUser?.uid;if(!t)return e.status(401).json({message:"Authentication required"});let n=J.partial().parse(o.body),i=await g.updateUser(t,n);if(!i)return e.status(404).json({message:"User not found"});e.json(i)}catch(t){e.status(400).json({message:"Invalid user data",error:t instanceof Error?t.message:"Unknown error"})}}),r.get("/api/credits/check",N,async(o,e)=>{try{let t=o.user?.id;if(!t)return e.status(401).json({message:"Authentication required"});let n=await g.checkUserCanGenerate(t);e.json(n)}catch(t){console.error("Error checking credits:",t),e.status(500).json({error:"Failed to check credits"})}}),r.get("/api/generations/status",N,async(o,e)=>{try{let t=o.user?.id;if(!t)return e.status(401).json({message:"Authentication required"});let n=o.query.modelType||"gpt-4o",i=await g.checkUserCanGenerateWithModel(t,n);e.json(i)}catch(t){console.error("Error checking generation status:",t),e.status(500).json({error:"Failed to check generation status"})}}),r.post("/api/generate-hooks",Fe,N,async(o,e)=>{try{let t=o.user?.id;if(!t)return e.status(401).json({message:"Authentication required"});let{platform:n,objective:i,topic:a,modelType:u}=o.body;if(!n||!i||!a)return e.status(400).json({message:"Missing required fields: platform, objective, topic"});let l=await g.getUser(t);if(!l)return e.status(404).json({message:"User not found"});if(u||((l.subscriptionPlan||"free")==="free"?u="gpt-4o-mini":u="gpt-4o"),!["gpt-4o","gpt-4o-mini"].includes(u))return e.status(400).json({message:"Invalid model type. Must be 'gpt-4o' or 'gpt-4o-mini'"});(l.subscriptionPlan||"free")==="free"&&u==="gpt-4o"&&(u="gpt-4o-mini",console.log("Free user attempted to use gpt-4o, automatically switched to gpt-4o-mini")),console.log(`Final model selection: ${u} for user plan: ${l.subscriptionPlan||"free"}`);let _=await g.checkUserCanGenerateWithModel(t,u);if(!_.canGenerate)return e.status(403).json({error:_.reason||"Generation limit reached",remainingProGenerations:_.remainingProGenerations,remainingDraftGenerations:_.remainingDraftGenerations,isAtLimit:!0});console.log(`Generating tri-modal hooks for ${n} with topic: "${a}"`),console.log(`User profile: ${l.company} (${l.industry}, ${l.role})`),console.log(`Audience: ${l.audience?.substring(0,100)}...`);let S=await Ce({topic:a,platform:n,objective:i,modelType:u,company:l.company||"Unknown Company",role:l.role||"Creator",industry:l.industry||"General",audience:l.audience||"General Audience",voice:l.voice||"Friendly",bannedTerms:l.bannedTerms||[],safety:"standard"}),A=await g.createHookGeneration({userId:t,platform:n,objective:i,topic:a,modelType:u,hooks:S.hooks,topThreeVariants:S.topThreeVariants});await g.incrementUserGenerations(t,u),e.json(A)}catch(t){console.error("Hook generation error:",t),e.status(500).json({message:"Failed to generate hooks",error:t instanceof Error?t.message:"Unknown error"})}}),r.get("/api/generations",N,async(o,e)=>{try{let t=o.user?.id;if(!t)return e.status(401).json({message:"Authentication required"});let n=await g.getHookGenerationsByUser(t);e.json(n)}catch(t){e.status(500).json({message:"Failed to fetch generations",error:t instanceof Error?t.message:"Unknown error"})}}),r.get("/api/generation/:id",async(o,e)=>{try{let t=await g.getHookGeneration(o.params.id);if(!t)return e.status(404).json({message:"Generation not found"});e.json(t)}catch(t){e.status(500).json({message:"Failed to fetch generation",error:t instanceof Error?t.message:"Unknown error"})}}),r.post("/api/favorites",N,async(o,e)=>{try{let t=o.user?.id;if(!t)return e.status(401).json({message:"Authentication required"});console.log("Received favorite data:",o.body);let n=le.parse({...o.body,userId:t});console.log("Parsed favorite data:",n);let i=await g.createFavoriteHook(n);n.hook&&await g.addRecentHook({userId:t,hook:n.hook}),e.json(i)}catch(t){console.error("Favorite creation error:",t),e.status(400).json({message:"Invalid favorite data",error:t instanceof Error?t.message:"Unknown error"})}}),r.get("/api/favorites",N,async(o,e)=>{try{let t=o.user?.id;if(!t)return e.status(401).json({message:"Authentication required"});let n=await g.getFavoriteHooksByUser(t);e.json(n)}catch(t){e.status(500).json({message:"Failed to fetch favorites",error:t instanceof Error?t.message:"Unknown error"})}}),r.delete("/api/favorites/:id",N,async(o,e)=>{try{if(!await g.deleteFavoriteHook(o.params.id))return e.status(404).json({message:"Favorite not found"});e.json({message:"Favorite deleted successfully"})}catch(t){e.status(500).json({message:"Failed to delete favorite",error:t instanceof Error?t.message:"Unknown error"})}}),r.post("/api/export-csv",N,async(o,e)=>{try{let{generationId:t}=o.body;if(!t)return e.status(400).json({message:"Generation ID is required"});let n=await g.getHookGeneration(t);if(!n)return e.status(404).json({message:"Generation not found"});let i=`Hook,Framework,Rationale,Platform Notes,Score,Word Count
`,a=n.hooks.map(l=>`"${l.verbalHook}","${l.framework}","${l.rationale}","${l.platformNotes}",${l.score},${l.wordCount}`).join(`
`),u=i+a;e.setHeader("Content-Type","text/csv"),e.setHeader("Content-Disposition",`attachment; filename="hooks-${n.platform}-${Date.now()}.csv"`),e.send(u)}catch(t){e.status(500).json({message:"Failed to export CSV",error:t instanceof Error?t.message:"Unknown error"})}}),r.delete("/api/generations/:generationId",N,async(o,e)=>{try{let{generationId:t}=o.params,n=o.user?.id;if(!n)return e.status(401).json({message:"Authentication required"});let i=await g.getGenerationById(t);if(!i||i.userId!==n)return e.status(404).json({message:"Generation not found"});await g.deleteGeneration(t),e.json({message:"Generation deleted successfully"})}catch(t){console.error("Error deleting generation:",t),e.status(500).json({message:"Failed to delete generation"})}}),r.get("/api/stripe/plans",(o,e)=>{e.json({plans:te})}),r.post("/api/stripe/create-subscription",N,async(o,e)=>{try{let t=o.user?.id;if(!t)return e.status(401).json({message:"Authentication required"});let n=await g.getUser(t);if(!n?.email)return e.status(400).json({message:"User email not found"});let{plan:i,promotionCode:a}=o.body;if(!i||!["starter","creator","pro","teams"].includes(i.toLowerCase()))return e.status(400).json({message:"Invalid plan. Must be 'starter', 'creator', 'pro', or 'teams'"});let u=i.toUpperCase(),l=te[u].priceId;if(!l)return e.status(400).json({message:"Price ID not configured for this plan"});let _=await me(t,n.email,l,a);await g.updateUser(t,{subscriptionPlan:i.toLowerCase(),subscriptionStatus:"trialing"}),e.json(_)}catch(t){console.error("Error creating subscription:",t),e.status(500).json({message:"Failed to create subscription",error:t instanceof Error?t.message:"Unknown error"})}}),r.get("/api/stripe/subscription",N,async(o,e)=>{try{let t=o.user?.id;if(!t)return e.status(401).json({message:"Authentication required"});let n=await g.getUser(t);if(!n?.stripeSubscriptionId)return e.status(404).json({message:"No subscription found"});let i=await fe(n.stripeSubscriptionId);e.json(i)}catch(t){console.error("Error fetching subscription:",t),e.status(500).json({message:"Failed to fetch subscription",error:t instanceof Error?t.message:"Unknown error"})}}),r.post("/api/stripe/portal",N,async(o,e)=>{try{let t=o.user?.id;if(!t)return e.status(401).json({message:"Authentication required"});let n=await g.getUser(t),{returnUrl:i}=o.body;if(!n?.stripeCustomerId)return e.status(400).json({message:"No Stripe customer found"});let a=await pe(n.stripeCustomerId,i||`${o.protocol}://${o.get("host")}/app`);e.json({url:a})}catch(t){console.error("Error creating portal session:",t),e.status(500).json({message:"Failed to create portal session",error:t instanceof Error?t.message:"Unknown error"})}}),r.post("/api/stripe/cancel",N,async(o,e)=>{try{let t=o.user?.id;if(!t)return e.status(401).json({message:"Authentication required"});let n=await g.getUser(t);if(!n?.stripeSubscriptionId)return e.status(404).json({message:"No active subscription found"});await ge(n.stripeSubscriptionId),await g.updateUser(t,{cancelAtPeriodEnd:!0}),e.json({message:"Subscription will be canceled at the end of the billing period"})}catch(t){console.error("Error cancelling subscription:",t),e.status(500).json({message:"Failed to cancel subscription",error:t instanceof Error?t.message:"Unknown error"})}}),r.post("/api/stripe/webhook",xt.raw({type:"application/json"}),async(o,e)=>{let t=o.headers["stripe-signature"],n=process.env.STRIPE_WEBHOOK_SECRET;if(!n)return console.error("Stripe webhook secret not configured"),e.status(500).json({error:"Server configuration error"});try{let i=Ct.webhooks.constructEvent(o.body,t,n);await he(i),e.json({received:!0})}catch(i){console.error("Webhook signature verification failed:",i),e.status(400).json({error:"Invalid webhook signature"})}}),Tt(r)}import Ot from"express";import Ve from"fs";import be from"path";import{createServer as Gt,createLogger as Ft}from"vite";import{defineConfig as Ht}from"vite";import Dt from"@vitejs/plugin-react";import se from"path";var Me=Ht(async({mode:r})=>({plugins:[Dt({jsxRuntime:"automatic",jsxImportSource:"react"}),...r!=="production"&&process.env.REPL_ID!==void 0?[(await import("@replit/vite-plugin-runtime-error-modal")).default(),(await import("@replit/vite-plugin-cartographer")).cartographer()]:[]],resolve:{alias:{"@":se.resolve(import.meta.dirname,"client","src"),"@shared":se.resolve(import.meta.dirname,"shared")}},root:se.resolve(import.meta.dirname,"client"),build:{outDir:se.resolve(import.meta.dirname,"dist/public"),emptyOutDir:!0,assetsDir:"assets",target:"es2020",minify:"esbuild",sourcemap:!1,rollupOptions:{output:{assetFileNames:s=>{let o=s.name?.split(".")||[],e=o[o.length-1]||"";return/png|jpe?g|svg|gif|tiff|bmp|ico/i.test(e)?"assets/images/[name]-[hash][extname]":/css/i.test(e)?"assets/css/[name]-[hash][extname]":"assets/[name]-[hash][extname]"},chunkFileNames:"assets/js/[name]-[hash]-v2025.08.03.001.js",entryFileNames:"assets/js/[name]-[hash]-v2025.08.03.001.js"}},chunkSizeWarningLimit:1e3,assetsInlineLimit:4096,cssCodeSplit:!0,reportCompressedSize:!1,write:!0},server:{fs:{strict:!0,deny:["**/.*"]}}}));import{nanoid as Lt}from"nanoid";var qe=Ft();async function We(r,s){let o={middlewareMode:!0,hmr:{server:s},allowedHosts:!0},e=await Gt({...Me,configFile:!1,customLogger:{...qe,error:(t,n)=>{qe.error(t,n),process.exit(1)}},server:o,appType:"custom"});r.use(e.middlewares),r.use("*",async(t,n,i)=>{let a=t.originalUrl;try{let u=be.resolve(import.meta.dirname,"..","client","index.html"),l=await Ve.promises.readFile(u,"utf-8");l=l.replace('src="/src/main.tsx"',`src="/src/main.tsx?v=${Lt()}"`);let _=await e.transformIndexHtml(a,l);n.status(200).set({"Content-Type":"text/html"}).end(_)}catch(u){e.ssrFixStacktrace(u),i(u)}})}function Ke(r){let s=be.resolve(import.meta.dirname,"public");if(!Ve.existsSync(s))throw new Error(`Could not find the build directory: ${s}, make sure to build the client first`);r.use(Ot.static(s,{maxAge:"1y",etag:!0,lastModified:!0,setHeaders:(o,e)=>{e.endsWith(".html")&&(o.setHeader("Cache-Control","no-cache, no-store, must-revalidate"),o.setHeader("Pragma","no-cache"),o.setHeader("Expires","0")),o.setHeader("X-Content-Type-Options","nosniff"),o.setHeader("X-Frame-Options","DENY")}})),r.use("*",(o,e)=>{e.setHeader("Cache-Control","no-cache, no-store, must-revalidate"),e.setHeader("Pragma","no-cache"),e.setHeader("Expires","0"),e.sendFile(be.resolve(s,"index.html"))})}function Ye(r,s,o){s.setHeader("Strict-Transport-Security","max-age=31536000; includeSubDomains; preload"),s.setHeader("Content-Security-Policy",["default-src 'self'","script-src 'self' 'unsafe-inline' https://js.stripe.com https://maps.googleapis.com https://www.gstatic.com","style-src 'self' 'unsafe-inline' https://fonts.googleapis.com","font-src 'self' https://fonts.gstatic.com","img-src 'self' data: https:","connect-src 'self' https://api.stripe.com https://api.openai.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://hook-line-studio-default-rtdb.firebaseio.com https://firebaseinstallations.googleapis.com","frame-src https://js.stripe.com https://hooks.stripe.com","form-action 'self'","base-uri 'self'","object-src 'none'"].join("; ")),s.setHeader("X-Frame-Options","DENY"),s.setHeader("X-Content-Type-Options","nosniff"),s.setHeader("Referrer-Policy","strict-origin-when-cross-origin"),s.setHeader("Permissions-Policy",["camera=()","microphone=()","geolocation=()","payment=(self)"].join(", ")),s.setHeader("X-XSS-Protection","1; mode=block"),s.removeHeader("X-Powered-By"),o()}function ze(r,s,o){if(!r.secure&&r.get("X-Forwarded-Proto")!=="https")return s.redirect(301,`https://${r.get("Host")}${r.url}`);o()}import{z as d}from"zod";var jt=d.object({NODE_ENV:d.enum(["development","production","test"]).default("development"),PORT:d.string().transform(Number).pipe(d.number().min(1).max(65535)).default("5000"),DATABASE_URL:d.string().url("DATABASE_URL must be a valid PostgreSQL connection string"),FIREBASE_PROJECT_ID:d.string().min(1,"FIREBASE_PROJECT_ID is required"),FIREBASE_CLIENT_EMAIL:d.string().email("FIREBASE_CLIENT_EMAIL must be a valid email"),FIREBASE_PRIVATE_KEY:d.string().min(1,"FIREBASE_PRIVATE_KEY is required"),OPENAI_API_KEY:d.string().min(1,"OPENAI_API_KEY is required"),STRIPE_SECRET_KEY:d.string().min(1,"STRIPE_SECRET_KEY is required"),STRIPE_WEBHOOK_SECRET:d.string().min(1,"STRIPE_WEBHOOK_SECRET is required"),ANALYTICS_ENABLED:d.string().transform(Boolean).default("true"),ANALYTICS_BATCH_SIZE:d.string().transform(Number).pipe(d.number().min(1).max(1e3)).default("100"),ANALYTICS_FLUSH_INTERVAL:d.string().transform(Number).pipe(d.number().min(1e3)).default("10000"),ANALYTICS_SAMPLING_RATE:d.string().transform(Number).pipe(d.number().min(0).max(1)).default("1.0"),AB_TESTING_ENABLED:d.string().transform(Boolean).default("true"),AB_TESTING_DEFAULT_TRAFFIC:d.string().transform(Number).pipe(d.number().min(0).max(1)).default("1.0"),AB_TESTING_MIN_SAMPLE_SIZE:d.string().transform(Number).pipe(d.number().min(10)).default("100"),CONVERSION_TRACKING_ENABLED:d.string().transform(Boolean).default("true"),CONVERSION_API_ENDPOINT:d.string().default("/api/analytics/track"),CONVERSION_RETENTION_DAYS:d.string().transform(Number).pipe(d.number().min(1).max(365)).default("90"),GDPR_COMPLIANCE_ENABLED:d.string().transform(Boolean).default("true"),CCPA_COMPLIANCE_ENABLED:d.string().transform(Boolean).default("true"),ANONYMIZE_IPS:d.string().transform(Boolean).default("true"),DATA_RETENTION_DAYS:d.string().transform(Number).pipe(d.number().min(30).max(2555)).default("730"),ENABLE_COMPRESSION:d.string().transform(Boolean).default("true"),CACHE_MAX_AGE:d.string().transform(Number).pipe(d.number().min(0)).default("86400"),CDN_CACHE_CONTROL:d.string().default("public, max-age=31536000, immutable"),ANALYTICS_RATE_LIMIT_REQUESTS:d.string().transform(Number).pipe(d.number().min(1)).default("1000"),ANALYTICS_RATE_LIMIT_WINDOW:d.string().transform(Number).pipe(d.number().min(60)).default("900"),ENABLE_PERFORMANCE_MONITORING:d.string().transform(Boolean).default("true"),PERFORMANCE_THRESHOLD_P95:d.string().transform(Number).pipe(d.number().min(100)).default("500"),ERROR_RATE_THRESHOLD:d.string().transform(Number).pipe(d.number().min(0).max(1)).default("0.05"),GOOGLE_ANALYTICS_MEASUREMENT_ID:d.string().optional(),MIXPANEL_PROJECT_TOKEN:d.string().optional(),SEGMENT_WRITE_KEY:d.string().optional(),REPL_ID:d.string().optional(),RAILWAY_ENVIRONMENT:d.string().optional(),RAILWAY_PROJECT_ID:d.string().optional(),RAILWAY_SERVICE_ID:d.string().optional(),LOG_LEVEL:d.enum(["error","warn","info","debug"]).default("info"),ENABLE_REQUEST_LOGGING:d.string().transform(Boolean).default("true")}),$;function ne(){if($)return $;try{return $=jt.parse(process.env),$.NODE_ENV==="development"&&console.log("\u2705 Environment variables validated successfully"),$}catch(r){if(r instanceof d.ZodError){let s=r.errors.map(o=>`${o.path.join(".")}: ${o.message}`);throw console.error("\u274C Environment validation failed:"),s.forEach(o=>console.error(`  - ${o}`)),console.error("\u{1F6A8} Cannot start server with invalid environment configuration"),process.exit(1),new Error(`Environment validation failed: ${s.join(", ")}`)}throw r}}function B(){return $||ne()}function M(){return B().NODE_ENV==="production"}ne();var Ie=class{env=B();service="hook-line-studio";createLogEntry(s,o,e,t){let n={level:s,message:o,timestamp:new Date().toISOString(),environment:this.env.NODE_ENV,service:this.service};return e&&(n.data=e),t&&(n.error={name:t.name,message:t.message,stack:M()?void 0:t.stack}),n}shouldLog(s){let o=["error","warn","info","debug"],e=o.indexOf(this.env.LOG_LEVEL);return o.indexOf(s)<=e}output(s){if(this.shouldLog(s.level))if(M())console.log(JSON.stringify(s));else{let e=`[${new Date(s.timestamp).toLocaleTimeString()}] ${s.level.toUpperCase()}:`;if(s.error)console.log(`${e} ${s.message}`),console.error(s.error.stack||s.error.message),s.data&&console.log("Data:",s.data);else{let t=s.data?` ${JSON.stringify(s.data)}`:"";console.log(`${e} ${s.message}${t}`)}}}error(s,o,e){this.output(this.createLogEntry("error",s,e,o))}warn(s,o){this.output(this.createLogEntry("warn",s,o))}info(s,o){this.output(this.createLogEntry("info",s,o))}debug(s,o){this.output(this.createLogEntry("debug",s,o))}logRequest(s,o,e){let t=o.statusCode,n=t>=500?"error":t>=400?"warn":"info";this.output(this.createLogEntry(n,"HTTP Request",{method:s.method,path:s.path,statusCode:t,duration:`${e}ms`,ip:s.ip||s.connection?.remoteAddress,userAgent:s.get?.("User-Agent")?.substring(0,100),userId:s.user?.id||s.firebaseUser?.uid}))}logDatabase(s,o,e,t){t?this.error(`Database ${s} failed`,t,{table:o,duration:e}):this.debug(`Database ${s}`,{table:o,duration:e})}logExternalAPI(s,o,e,t){t?this.error(`${s} API call failed`,t,{operation:o,duration:e}):this.info(`${s} API call`,{operation:o,duration:e})}},b=new Ie;q();import $t from"connect-history-api-fallback";ne();var x=Se();x.get("/health",async(r,s)=>{let o=Date.now(),e=B(),t={status:"healthy",timestamp:new Date().toISOString(),environment:e.NODE_ENV,uptime:process.uptime(),version:process.env.npm_package_version||"1.0.0",services:{database:"unknown",firebase:e.FIREBASE_PROJECT_ID?"configured":"not_configured",stripe:e.STRIPE_SECRET_KEY?"configured":"not_configured",openai:e.OPENAI_API_KEY?"configured":"not_configured",analytics:e.ANALYTICS_ENABLED?"enabled":"disabled",abTesting:e.AB_TESTING_ENABLED?"enabled":"disabled"},conversion:{tracking:e.CONVERSION_TRACKING_ENABLED,privacy:{gdpr:e.GDPR_COMPLIANCE_ENABLED,ccpa:e.CCPA_COMPLIANCE_ENABLED,anonymizeIps:e.ANONYMIZE_IPS},performance:{monitoring:e.ENABLE_PERFORMANCE_MONITORING,threshold:`${e.PERFORMANCE_THRESHOLD_P95}ms`,errorThreshold:`${(e.ERROR_RATE_THRESHOLD*100).toFixed(1)}%`}},checks:{memory:{used:Math.round(process.memoryUsage().heapUsed/1024/1024),free:Math.round(process.memoryUsage().heapTotal/1024/1024),total:Math.round(process.memoryUsage().rss/1024/1024)}}};try{let{testDatabaseConnection:i}=await Promise.resolve().then(()=>(q(),ee)),a=await i(1e4);if(a.success)t.services.database="connected",t.services.databaseDetails=a.connectionInfo;else throw new Error(a.error||"Unknown database error");try{let{pool:u}=await Promise.resolve().then(()=>(q(),ee)),l=u.query(`
        SELECT table_name 
        FROM information_schema.tables 
        WHERE table_schema = 'public' 
        AND table_name IN ('analytics_events', 'ab_tests', 'conversion_funnels', 'user_consent')
      `),_=await Promise.race([l,new Promise((A,P)=>setTimeout(()=>P(new Error("Conversion tables check timeout")),5e3))]),S=_.rows.map(A=>A.table_name);t.conversion={...t.conversion,tablesReady:_.rows.length===4,tablesFound:S,tableCount:_.rows.length}}catch(u){b.warn("Conversion tables check failed:",u),t.conversion={...t.conversion,tablesReady:!1,error:u instanceof Error?u.message:String(u)}}}catch(i){b.error("Health check database error:",i),t.services.database="disconnected",t.services.databaseError=i.message,t.status="unhealthy";let a=Date.now()-o;if(t.checks={...t.checks,responseTime:`${a}ms`},M())return s.status(503).json(t)}let n=Date.now()-o;t.checks={...t.checks,responseTime:`${n}ms`},s.status(200).json(t)});x.get("/ready",(r,s)=>{s.status(200).json({status:"ready",timestamp:new Date().toISOString(),uptime:process.uptime()})});x.get("/live",(r,s)=>{s.status(200).json({status:"alive",timestamp:new Date().toISOString(),uptime:process.uptime(),environment:"production",railway:process.env.RAILWAY_ENVIRONMENT||"local"})});x.use(ze);x.use(Ye);x.use(Se.json());x.use(Se.urlencoded({extended:!1}));x.use((r,s,o)=>{if(!B().ENABLE_REQUEST_LOGGING)return o();let e=Date.now();s.on("finish",()=>{let t=Date.now()-e;(r.path.startsWith("/api")||s.statusCode>=400)&&b.logRequest(r,s,t)}),o()});(async()=>{try{if(b.info("Starting application server..."),M()){b.info("Initializing database connection for production...");try{let{initializeDatabase:n}=await Promise.resolve().then(()=>(q(),ee));await n(),b.info("\u2705 Database connection initialized successfully")}catch(n){b.error("\u274C Failed to initialize database connection:",n),b.warn("\u26A0\uFE0F Continuing startup despite database connection failure - health checks will monitor connectivity")}}let r=await Be(x);x.use((n,i,a,u)=>{let l=n.status||n.statusCode||500,_=n.message||"Internal Server Error";b.error(`HTTP Error ${l}`,n),a.status(l).json({message:_})}),x.get("env")==="development"?await We(x,r):(x.use($t({disableDotRule:!0,htmlAcceptHeaders:["text/html","application/xhtml+xml"]})),Ke(x));let s=B(),o=s.PORT,e=r.listen({port:o,host:"0.0.0.0",reusePort:!0},()=>{b.info("Server started",{port:o,environment:s.NODE_ENV,railway:s.RAILWAY_ENVIRONMENT||"local",healthCheck:"/live",readinessCheck:"/ready"})}),t=n=>{b.warn(`Received ${n}. Starting graceful shutdown...`),e.close(a=>{a&&(b.error("Error during server shutdown",a),process.exit(1)),b.info("Server closed successfully"),typeof F?.end=="function"?F.end().then(()=>{b.info("Database connections closed"),process.exit(0)}).catch(u=>{b.error("Error closing database connections",u),process.exit(1)}):process.exit(0)});let i=s.RAILWAY_ENVIRONMENT?25e3:3e4;setTimeout(()=>{b.error(`Forced shutdown after ${i/1e3} seconds`),process.exit(1)},i)};process.on("SIGTERM",()=>t("SIGTERM")),process.on("SIGINT",()=>t("SIGINT")),M()&&(process.on("uncaughtException",n=>{b.error("Uncaught Exception",n),t("UNCAUGHT_EXCEPTION")}),process.on("unhandledRejection",(n,i)=>{b.error("Unhandled Rejection",n instanceof Error?n:new Error(String(n)),{promise:String(i)}),t("UNHANDLED_REJECTION")}))}catch(r){b.error("Failed to start server",r instanceof Error?r:new Error(String(r))),process.exit(1)}})();
//# sourceMappingURL=index.js.map
