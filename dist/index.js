var Xe=Object.defineProperty;var Y=(e,o)=>()=>(e&&(o=e(e=0)),o);var ae=(e,o)=>{for(var s in o)Xe(e,s,{get:o[s],enumerable:!0})};var de={};ae(de,{abTestParticipants:()=>tt,abTests:()=>Ae,analyticsEvents:()=>et,conversionFunnels:()=>Ne,favoriteHooks:()=>E,funnelEvents:()=>rt,hookGenerations:()=>f,insertFavoriteHookSchema:()=>le,insertHookGenerationSchema:()=>nt,insertUserRecentHookSchema:()=>it,insertUserSchema:()=>J,loginSchema:()=>ue,registerSchema:()=>ce,sessions:()=>Ze,upsertUserSchema:()=>ot,userConsent:()=>st,userRecentHooks:()=>U,users:()=>c});import{sql as k}from"drizzle-orm";import{pgTable as D,text as b,varchar as m,jsonb as R,timestamp as w,boolean as H,index as p,integer as G,check as P}from"drizzle-orm/pg-core";import{createInsertSchema as z}from"drizzle-zod";import{z as h}from"zod";var Ze,c,f,E,U,et,Ae,tt,Ne,rt,st,ce,ue,J,ot,nt,le,it,Q=Y(()=>{"use strict";Ze=D("sessions",{sid:m("sid").primaryKey(),sess:R("sess").notNull(),expire:w("expire").notNull()},e=>[p("IDX_session_expire").on(e.expire)]),c=D("users",{id:m("id").primaryKey().default(k`gen_random_uuid()`),email:m("email").notNull().unique(),password:m("password"),firebaseUid:m("firebase_uid").unique(),firstName:m("first_name"),lastName:m("last_name"),emailVerified:H("email_verified").default(!1),profileImageUrl:m("profile_image_url"),company:b("company"),industry:b("industry"),role:b("role"),audience:b("audience"),voice:b("voice"),bannedTerms:R("banned_terms").$type().default([]),safety:b("safety").default("standard"),proGenerationsUsed:G("pro_generations_used").default(0),draftGenerationsUsed:G("draft_generations_used").default(0),weeklyDraftReset:w("weekly_draft_reset").defaultNow(),freeCredits:G("free_credits").default(5),usedCredits:G("used_credits").default(0),isPremium:H("is_premium").default(!1),stripeCustomerId:m("stripe_customer_id"),stripeSubscriptionId:m("stripe_subscription_id"),subscriptionStatus:m("subscription_status").default("free"),subscriptionPlan:m("subscription_plan").default("free"),currentPeriodEnd:w("current_period_end"),cancelAtPeriodEnd:H("cancel_at_period_end").default(!1),createdAt:w("created_at").defaultNow(),updatedAt:w("updated_at").defaultNow()},e=>[p("idx_users_email").on(e.email),p("idx_users_firebase_uid").on(e.firebaseUid),p("idx_users_stripe_customer_id").on(e.stripeCustomerId),p("idx_users_created_at").on(e.createdAt),p("idx_users_subscription_status").on(e.subscriptionStatus),P("email_format",k`${e.email} ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'`),P("safety_values",k`${e.safety} IN ('family-friendly', 'standard', 'edgy')`),P("subscription_status_values",k`${e.subscriptionStatus} IN ('free', 'active', 'canceled', 'past_due', 'trialing', 'unpaid')`),P("subscription_plan_values",k`${e.subscriptionPlan} IN ('free', 'starter', 'creator', 'pro', 'teams')`),P("positive_generations",k`${e.proGenerationsUsed} >= 0 AND ${e.draftGenerationsUsed} >= 0`),P("positive_credits",k`${e.freeCredits} >= 0 AND ${e.usedCredits} >= 0`)]),f=D("hook_generations",{id:m("id").primaryKey().default(k`gen_random_uuid()`),userId:m("user_id").notNull().references(()=>c.id,{onDelete:"cascade"}),platform:b("platform").notNull(),objective:b("objective").notNull(),topic:b("topic").notNull(),modelType:b("model_type").notNull().default("gpt-4o"),hooks:R("hooks").$type().notNull(),topThreeVariants:R("top_three_variants").$type(),createdAt:w("created_at").defaultNow()},e=>[p("idx_hook_generations_user_id").on(e.userId),p("idx_hook_generations_created_at").on(e.createdAt),p("idx_hook_generations_platform").on(e.platform),p("idx_hook_generations_user_platform").on(e.userId,e.platform),p("idx_hook_generations_user_created").on(e.userId,e.createdAt),P("platform_values",k`${e.platform} IN ('tiktok', 'instagram', 'youtube', 'twitter', 'linkedin')`),P("objective_values",k`${e.objective} IN ('watch_time', 'shares', 'saves', 'ctr', 'engagement', 'conversions')`),P("model_type_values",k`${e.modelType} IN ('gpt-4o', 'gpt-4o-mini')`)]),E=D("favorite_hooks",{id:m("id").primaryKey().default(k`gen_random_uuid()`),userId:m("user_id").notNull().references(()=>c.id,{onDelete:"cascade"}),generationId:m("generation_id").references(()=>f.id,{onDelete:"set null"}),hook:b("hook"),hookData:R("hook_data").$type(),framework:b("framework").notNull(),platformNotes:b("platform_notes").notNull(),topic:b("topic"),platform:b("platform"),createdAt:w("created_at").defaultNow()},e=>[p("idx_favorite_hooks_user_id").on(e.userId),p("idx_favorite_hooks_created_at").on(e.createdAt),p("idx_favorite_hooks_user_created").on(e.userId,e.createdAt),p("idx_favorite_hooks_generation_id").on(e.generationId),p("idx_favorite_hooks_unique_user_generation").on(e.userId,e.generationId)]),U=D("user_recent_hooks",{id:m("id").primaryKey().default(k`gen_random_uuid()`),userId:m("user_id").notNull().references(()=>c.id,{onDelete:"cascade"}),hook:b("hook").notNull(),createdAt:w("created_at").defaultNow()},e=>[p("idx_user_recent_hooks_user_id").on(e.userId),p("idx_user_recent_hooks_created_at").on(e.createdAt),p("idx_user_recent_hooks_user_created").on(e.userId,e.createdAt)]),et=D("analytics_events",{id:m("id").primaryKey().default(k`gen_random_uuid()`),sessionId:m("session_id").notNull(),userId:m("user_id").references(()=>c.id,{onDelete:"set null"}),eventType:m("event_type").notNull(),eventData:R("event_data").$type().notNull().default({}),deviceInfo:R("device_info").$type().notNull(),pageInfo:R("page_info").$type().notNull(),ipAddress:m("ip_address"),userConsent:H("user_consent").default(!1),createdAt:w("created_at").defaultNow()},e=>[p("idx_analytics_events_session_id").on(e.sessionId),p("idx_analytics_events_user_id").on(e.userId),p("idx_analytics_events_event_type").on(e.eventType),p("idx_analytics_events_created_at").on(e.createdAt),p("idx_analytics_events_user_event_type").on(e.userId,e.eventType),p("idx_analytics_events_session_created").on(e.sessionId,e.createdAt),P("event_type_values",k`${e.eventType} IN ('cta_click', 'cta_view', 'cta_hover', 'trust_signal_view', 'urgency_indicator_view', 'funnel_step', 'ab_test_exposure', 'error', 'performance', 'page_view', 'user_identified', 'session_reset', 'conversion')`)]),Ae=D("ab_tests",{id:m("id").primaryKey().default(k`gen_random_uuid()`),testName:m("test_name").notNull(),testDescription:b("test_description"),status:m("status").notNull().default("draft"),variants:R("variants").$type().notNull(),trafficAllocation:G("traffic_allocation").notNull().default(100),targetingRules:R("targeting_rules").$type(),minSampleSize:G("min_sample_size").default(100),significanceLevel:G("significance_level").default(95),primaryMetric:m("primary_metric").default("conversion_rate"),startDate:w("start_date"),endDate:w("end_date"),winnerVariant:m("winner_variant"),createdBy:m("created_by").references(()=>c.id,{onDelete:"set null"}),createdAt:w("created_at").defaultNow(),updatedAt:w("updated_at").defaultNow()},e=>[p("idx_ab_tests_status").on(e.status),p("idx_ab_tests_created_at").on(e.createdAt),p("idx_ab_tests_start_end_date").on(e.startDate,e.endDate),P("status_values",k`${e.status} IN ('draft', 'running', 'paused', 'completed', 'archived')`),P("traffic_allocation_range",k`${e.trafficAllocation} >= 0 AND ${e.trafficAllocation} <= 100`),P("significance_level_range",k`${e.significanceLevel} >= 90 AND ${e.significanceLevel} <= 99`)]),tt=D("ab_test_participants",{id:m("id").primaryKey().default(k`gen_random_uuid()`),testId:m("test_id").notNull().references(()=>Ae.id,{onDelete:"cascade"}),sessionId:m("session_id").notNull(),userId:m("user_id").references(()=>c.id,{onDelete:"set null"}),variantId:m("variant_id").notNull(),exposureTime:w("exposure_time").defaultNow(),converted:H("converted").default(!1),conversionTime:w("conversion_time"),conversionValue:G("conversion_value").default(0),metadata:R("metadata").$type().default({}),createdAt:w("created_at").defaultNow()},e=>[p("idx_ab_test_participants_test_id").on(e.testId),p("idx_ab_test_participants_session_id").on(e.sessionId),p("idx_ab_test_participants_user_id").on(e.userId),p("idx_ab_test_participants_variant_id").on(e.variantId),p("idx_ab_test_participants_test_variant").on(e.testId,e.variantId),p("idx_ab_test_participants_converted").on(e.converted),p("idx_ab_test_participants_unique").on(e.testId,e.sessionId)]),Ne=D("conversion_funnels",{id:m("id").primaryKey().default(k`gen_random_uuid()`),funnelName:m("funnel_name").notNull(),funnelDescription:b("funnel_description"),steps:R("steps").$type().notNull(),isActive:H("is_active").default(!0),createdBy:m("created_by").references(()=>c.id,{onDelete:"set null"}),createdAt:w("created_at").defaultNow(),updatedAt:w("updated_at").defaultNow()},e=>[p("idx_conversion_funnels_active").on(e.isActive),p("idx_conversion_funnels_created_at").on(e.createdAt),p("idx_conversion_funnels_name").on(e.funnelName)]),rt=D("funnel_events",{id:m("id").primaryKey().default(k`gen_random_uuid()`),funnelId:m("funnel_id").notNull().references(()=>Ne.id,{onDelete:"cascade"}),sessionId:m("session_id").notNull(),userId:m("user_id").references(()=>c.id,{onDelete:"set null"}),stepIndex:G("step_index").notNull(),stepName:m("step_name").notNull(),previousStep:m("previous_step"),timeFromPrevious:G("time_from_previous"),abandoned:H("abandoned").default(!1),completed:H("completed").default(!1),eventData:R("event_data").$type().default({}),createdAt:w("created_at").defaultNow()},e=>[p("idx_funnel_events_funnel_id").on(e.funnelId),p("idx_funnel_events_session_id").on(e.sessionId),p("idx_funnel_events_user_id").on(e.userId),p("idx_funnel_events_step_index").on(e.stepIndex),p("idx_funnel_events_funnel_session").on(e.funnelId,e.sessionId),p("idx_funnel_events_completed").on(e.completed),p("idx_funnel_events_abandoned").on(e.abandoned)]),st=D("user_consent",{id:m("id").primaryKey().default(k`gen_random_uuid()`),sessionId:m("session_id").notNull(),userId:m("user_id").references(()=>c.id,{onDelete:"cascade"}),analyticsConsent:H("analytics_consent").default(!1),marketingConsent:H("marketing_consent").default(!1),personalizationConsent:H("personalization_consent").default(!1),consentVersion:m("consent_version").notNull().default("1.0"),ipAddress:m("ip_address"),userAgent:b("user_agent"),consentMethod:m("consent_method").default("explicit"),withdrawnAt:w("withdrawn_at"),createdAt:w("created_at").defaultNow(),updatedAt:w("updated_at").defaultNow()},e=>[p("idx_user_consent_session_id").on(e.sessionId),p("idx_user_consent_user_id").on(e.userId),p("idx_user_consent_analytics").on(e.analyticsConsent),p("idx_user_consent_created_at").on(e.createdAt),P("consent_method_values",k`${e.consentMethod} IN ('explicit', 'implicit', 'essential')`)]),ce=h.object({email:h.string().email("Please enter a valid email address"),password:h.string().min(6,"Password must be at least 6 characters"),firstName:h.string().min(1,"First name is required"),lastName:h.string().min(1,"Last name is required")}),ue=h.object({email:h.string().email("Please enter a valid email address"),password:h.string().min(1,"Password is required")}),J=z(c).omit({id:!0,password:!0,createdAt:!0,updatedAt:!0}).extend({platforms:h.array(h.string()).optional(),goals:h.array(h.string()).optional(),examples:h.string().optional()}),ot=z(c).pick({id:!0,email:!0,firstName:!0,lastName:!0,profileImageUrl:!0}),nt=z(f).omit({id:!0,createdAt:!0}),le=h.object({userId:h.string(),hook:h.string().optional(),generationId:h.string().optional(),framework:h.string(),platformNotes:h.string(),topic:h.string().optional(),platform:h.string().optional(),hookData:h.object({verbalHook:h.string(),visualHook:h.string().optional(),textualHook:h.string().optional(),framework:h.string(),psychologicalDriver:h.string().optional(),hookCategory:h.string().optional(),score:h.number().optional(),scoreBreakdown:h.string().optional(),rationale:h.string().optional(),platformNotes:h.string().optional(),platformSpecific:h.object({tiktokColdOpen:h.string().optional(),instagramOverlay:h.string().optional(),youtubeProofCue:h.string().optional()}).optional()}).optional()}),it=z(U).omit({id:!0,createdAt:!0})});var Te={};ae(Te,{db:()=>y,pool:()=>q});import{Pool as at,neonConfig as Pe}from"@neondatabase/serverless";import{drizzle as ct}from"drizzle-orm/neon-serverless";import ut from"ws";var ee,X,Z,q,y,te=Y(()=>{"use strict";Q();Pe.webSocketConstructor=ut;process.env.RAILWAY_ENVIRONMENT&&(Pe.wsProxy=e=>(e.includes("railway.internal")&&console.log(`Connecting to Railway internal database: ${e}`),`${e}`));if(!process.env.DATABASE_URL)throw new Error("DATABASE_URL must be set. Did you forget to provision a database?");ee=new URL(process.env.DATABASE_URL);if(ee.protocol!=="postgresql:"&&ee.protocol!=="postgres:")throw new Error("DATABASE_URL must use postgresql:// protocol");ee.searchParams.has("sslmode")||ee.searchParams.set("sslmode","require");X=!!process.env.RAILWAY_ENVIRONMENT,Z=process.env.DATABASE_URL?.includes("railway.internal"),q=new at({connectionString:process.env.DATABASE_URL,max:20,min:X?1:2,idleTimeoutMillis:X?3e4:6e4,connectionTimeoutMillis:Z?15e3:5e3,statementTimeout:2e4,query_timeout:2e4,acquireTimeoutMillis:Z?3e4:1e4,createTimeoutMillis:Z?15e3:5e3,destroyTimeoutMillis:3e3,reapIntervalMillis:2e3,createRetryIntervalMillis:Z?2e3:500,propagateCreateError:!1,allowExitOnIdle:X,maxUses:X?7500:1e4,application_name:`hooklinestudio-${process.env.RAILWAY_ENVIRONMENT||"local"}`}),y=ct({client:q,schema:de})});var xe={};ae(xe,{SUBSCRIPTION_PLANS:()=>re,cancelSubscription:()=>ge,createBillingPortalSession:()=>pe,createSubscription:()=>me,getOrCreateCustomer:()=>Re,getSubscriptionStatus:()=>fe,handleStripeWebhook:()=>he});import lt from"stripe";async function Re(e,o,s){try{let t=await g.getUser(e);if(t?.stripeCustomerId)return t.stripeCustomerId;let r=await O.customers.create({email:o,name:s||o,metadata:{userId:e}});return await g.updateStripeCustomerId(e,r.id),r.id}catch(t){throw console.error("Error creating/retrieving customer:",t),t}}async function me(e,o,s,t){try{let r=await Re(e,o),n={customer:r,items:[{price:s}],payment_behavior:"default_incomplete",payment_settings:{save_default_payment_method:"on_subscription"},expand:["latest_invoice.payment_intent"],trial_period_days:7};t&&(n.discounts=[{coupon:t}]);let i=await O.subscriptions.create(n);return await g.updateUserStripeInfo(e,{stripeCustomerId:r,stripeSubscriptionId:i.id}),{subscriptionId:i.id,clientSecret:i.latest_invoice&&typeof i.latest_invoice=="object"?i.latest_invoice.payment_intent?.client_secret:null,customerId:r}}catch(r){throw console.error("Error creating subscription:",r),r}}async function pe(e,o){try{return(await O.billingPortal.sessions.create({customer:e,return_url:o})).url}catch(s){throw console.error("Error creating billing portal session:",s),s}}async function fe(e){try{let o=await O.subscriptions.retrieve(e);return{status:o.status,currentPeriodEnd:new Date(o.current_period_end*1e3),cancelAtPeriodEnd:o.cancel_at_period_end,trialEnd:o.trial_end}}catch(o){throw console.error("Error getting subscription status:",o),o}}async function ge(e){try{return await O.subscriptions.update(e,{cancel_at_period_end:!0})}catch(o){throw console.error("Error canceling subscription:",o),o}}async function he(e){try{switch(e.type){case"invoice.payment_succeeded":let o=e.data.object;if(o.subscription){let a=await O.subscriptions.retrieve(o.subscription),d=await O.customers.retrieve(a.customer);d.metadata?.userId&&await g.updateUser(d.metadata.userId,{subscriptionStatus:"active",currentPeriodEnd:new Date(a.current_period_end*1e3),cancelAtPeriodEnd:a.cancel_at_period_end})}break;case"invoice.payment_failed":let s=e.data.object;if(s.subscription){let a=await O.subscriptions.retrieve(s.subscription),d=await O.customers.retrieve(a.customer);d.metadata?.userId&&await g.updateUser(d.metadata.userId,{subscriptionStatus:"past_due"})}break;case"customer.subscription.deleted":let t=e.data.object,r=await O.customers.retrieve(t.customer);r.metadata?.userId&&await g.updateUser(r.metadata.userId,{subscriptionStatus:"canceled",subscriptionPlan:"free",stripeSubscriptionId:null,cancelAtPeriodEnd:!1});break;case"customer.subscription.updated":let n=e.data.object,i=await O.customers.retrieve(n.customer);i.metadata?.userId&&await g.updateUser(i.metadata.userId,{subscriptionStatus:n.status,currentPeriodEnd:new Date(n.current_period_end*1e3),cancelAtPeriodEnd:n.cancel_at_period_end});break;default:console.log(`Unhandled event type: ${e.type}`)}}catch(o){throw console.error("Error handling webhook:",o),o}}var O,re,ye=Y(()=>{"use strict";se();if(!process.env.STRIPE_SECRET_KEY)throw new Error("Missing required Stripe secret: STRIPE_SECRET_KEY");O=new lt(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-06-30.basil"}),re={FREE:{name:"Free",priceId:null,amount:0,currency:"usd",interval:"month",features:["20 Draft generations per week (GPT-4o-mini)","Basic scoring insights","Community support"],limits:{draftGenerationsPerWeek:20,draftGenerationsPerMonth:-1,proGenerationsPerMonth:0,exports:!1,priority:!1,modelType:"gpt-4o-mini"}},STARTER:{name:"Starter",priceId:process.env.STRIPE_STARTER_PRICE_ID||"price_starter_placeholder",amount:9,currency:"usd",interval:"month",features:["100 Pro generations per month (GPT-4o)","Unlimited Draft generations (GPT-4o-mini)","Cancel anytime"],limits:{proGenerationsPerMonth:100,draftGenerationsPerMonth:-1,exports:!1,priority:!1,overageRate:3,modelType:"both"}},CREATOR:{name:"Creator",priceId:process.env.STRIPE_CREATOR_PRICE_ID||"price_creator_placeholder",amount:15,currency:"usd",interval:"month",features:["200 Pro generations per month (GPT-4o)","Unlimited Draft generations (GPT-4o-mini)","Cold-open exports"],limits:{proGenerationsPerMonth:200,draftGenerationsPerMonth:-1,exports:!0,coldOpenExports:!0,priority:!1,overageRate:3,modelType:"both"}},PRO:{name:"Pro",priceId:process.env.STRIPE_PRO_PRICE_ID||"price_pro_placeholder",amount:24,currency:"usd",interval:"month",features:["400 Pro generations per month (GPT-4o)","Unlimited Draft generations (GPT-4o-mini)","Sheets/CSV export","Advanced analytics"],limits:{proGenerationsPerMonth:400,draftGenerationsPerMonth:-1,exports:!0,sheetsExport:!0,analytics:!0,priority:!1,overageRate:2.5,modelType:"both"}},TEAMS:{name:"Teams",priceId:process.env.STRIPE_TEAMS_PRICE_ID||"price_teams_placeholder",amount:59,currency:"usd",interval:"month",features:["1,500 Pro generations pooled per month","3 seats included","Shared style guide","Priority support"],limits:{proGenerationsPerMonth:1500,draftGenerationsPerMonth:-1,exports:!0,teamSeats:3,sharedStyleGuide:!0,priority:!0,overageRate:2.5,modelType:"both"}}}});import{eq as v,desc as F,inArray as dt,and as mt,gte as pt,lte as ft,sql as oe}from"drizzle-orm";var _e,g,se=Y(()=>{"use strict";Q();te();_e=class{async getUser(o){let[s]=await y.select().from(c).where(v(c.id,o));return s||void 0}async getUserByEmail(o){let[s]=await y.select().from(c).where(v(c.email,o));return s||void 0}async getUserByUsername(o){let[s]=await y.select().from(c).where(v(c.company,o));return s||void 0}async getUserByFirebaseUid(o){let[s]=await y.select().from(c).where(v(c.firebaseUid,o));return s||void 0}async createUser(o){let[s]=await y.insert(c).values(o).returning();return s}async createUserFromFirebase(o){let[s]=await y.insert(c).values({...o,password:null}).returning();return s}async updateUser(o,s){let[t]=await y.update(c).set({...s,bannedTerms:s.bannedTerms?s.bannedTerms:void 0,updatedAt:new Date}).where(v(c.id,o)).returning();return t||void 0}async upsertUser(o){let s;if(o.email&&(s=await this.getUserByEmail(o.email)),!s&&o.firebaseUid&&(s=await this.getUserByFirebaseUid(o.firebaseUid)),s)return this.updateUser(s.id,o);{let[t]=await y.insert(c).values(o).returning();return t}}async incrementUserCredits(o){let s=await this.getUser(o);if(!s)return;let r=(s.usedCredits||0)+1;return this.updateUser(o,{usedCredits:r})}async checkUserCanGenerate(o){let s=await this.getUser(o);if(!s)return{canGenerate:!1,remainingCredits:0,isAtLimit:!0};if(s.isPremium)return{canGenerate:!0,remainingCredits:999,isAtLimit:!1};let t=s.freeCredits||5,r=s.usedCredits||0,n=Math.max(0,t-r),i=n===0;return{canGenerate:n>0,remainingCredits:n,isAtLimit:i}}async incrementUserGenerations(o,s){let t=await this.getUser(o);if(t)if(s==="gpt-4o"){let r=t.proGenerationsUsed||0;return this.updateUser(o,{proGenerationsUsed:r+1})}else{let r=t.draftGenerationsUsed||0;return this.updateUser(o,{draftGenerationsUsed:r+1})}}async checkUserCanGenerateWithModel(o,s){let t=await this.getUser(o);if(!t)return{canGenerate:!1,reason:"User not found",remainingProGenerations:0,remainingDraftGenerations:0,planLimits:null};let r=t.subscriptionPlan||"free",{SUBSCRIPTION_PLANS:n}=await Promise.resolve().then(()=>(ye(),xe)),i=r.toUpperCase(),a=n[i]?.limits;if(!a)return{canGenerate:!1,reason:"Invalid subscription plan",remainingProGenerations:0,remainingDraftGenerations:0,planLimits:null};let d=t.proGenerationsUsed||0,u=t.draftGenerationsUsed||0,_=0,S=0;if(r==="free"){let C=new Date(t.weeklyDraftReset||t.createdAt||new Date);Math.floor((Date.now()-C.getTime())/(10080*60*1e3))>=1?(await this.updateUser(o,{draftGenerationsUsed:0,weeklyDraftReset:new Date}),S=20):S=Math.max(0,20-u),_=0}else a.proGenerationsPerMonth===-1?_=999:_=Math.max(0,a.proGenerationsPerMonth-d),a.draftGenerationsPerMonth===-1?S=999:S=Math.max(0,a.draftGenerationsPerMonth-u);let A=!1,x;return s==="gpt-4o"?r==="free"?(A=!1,x="Pro generations require a paid subscription"):(A=_>0,A||(x=`Pro generation limit reached (${a.proGenerationsPerMonth}/month)`)):r==="free"?(A=S>0,A||(x="Weekly draft generation limit reached (20/week)")):(A=S>0,A||(x="Draft generation limit reached")),{canGenerate:A,reason:x,remainingProGenerations:_,remainingDraftGenerations:S,planLimits:a}}async resetUserGenerationCounts(o){return this.updateUser(o,{proGenerationsUsed:0,draftGenerationsUsed:0,weeklyDraftReset:new Date})}async createHookGeneration(o){let[s]=await y.insert(f).values({...o,hooks:o.hooks,topThreeVariants:o.topThreeVariants}).returning();return s}async getHookGenerationsByUser(o){return await y.select().from(f).where(v(f.userId,o)).orderBy(F(f.createdAt))}async getGenerationsByUserId(o){return this.getHookGenerationsByUser(o)}async getGenerationById(o){let[s]=await y.select().from(f).where(v(f.id,o));return s||null}async deleteGeneration(o){return((await y.delete(f).where(v(f.id,o))).rowCount??0)>0}async getHookGeneration(o){let[s]=await y.select().from(f).where(v(f.id,o));return s||void 0}async createFavoriteHook(o){let[s]=await y.insert(E).values(o).returning();return s}async getFavoriteHooksByUser(o){return await y.select().from(E).where(v(E.userId,o)).orderBy(F(E.createdAt))}async deleteFavoriteHook(o){try{return await y.delete(E).where(v(E.id,o)),!0}catch{return!1}}async addRecentHook(o){let[s]=await y.insert(U).values(o).returning();return await this.cleanupOldRecentHooks(o.userId),s}async getRecentHooksByUser(o){return await y.select().from(U).where(v(U.userId,o)).orderBy(F(U.createdAt)).limit(10)}async cleanupOldRecentHooks(o){let s=await y.select().from(U).where(v(U.userId,o)).orderBy(F(U.createdAt));if(s.length>10){let t=s.slice(10);for(let r of t)await y.delete(U).where(v(U.id,r.id))}}async resetUserCredits(o){let[s]=await y.update(c).set({usedCredits:0,updatedAt:new Date}).where(v(c.id,o)).returning();return s||void 0}async updateStripeCustomerId(o,s){try{let[t]=await y.update(c).set({stripeCustomerId:s}).where(v(c.id,o)).returning();return t||null}catch(t){throw console.error("Error updating stripe customer ID:",t),t}}async updateUserStripeInfo(o,s){try{let[t]=await y.update(c).set({stripeCustomerId:s.stripeCustomerId,stripeSubscriptionId:s.stripeSubscriptionId,isPremium:!0}).where(v(c.id,o)).returning();return t||null}catch(t){throw console.error("Error updating user stripe info:",t),t}}async updateUserSubscriptionStatus(o,s){try{let[t]=await y.update(c).set({isPremium:s.status==="active",updatedAt:new Date}).where(v(c.id,o)).returning();return t||null}catch(t){throw console.error("Error updating user subscription status:",t),t}}async getUserByStripeCustomerId(o){try{let[s]=await y.select().from(c).where(v(c.stripeCustomerId,o)).limit(1);return s||null}catch(s){throw console.error("Error finding user by stripe customer ID:",s),s}}async getUsersWithGenerationsCount(o){return o.length===0?[]:await y.select({id:c.id,email:c.email,firstName:c.firstName,lastName:c.lastName,company:c.company,subscriptionPlan:c.subscriptionPlan,subscriptionStatus:c.subscriptionStatus,createdAt:c.createdAt,generationsCount:oe`COUNT(${f.id})::int`.as("generations_count")}).from(c).leftJoin(f,v(c.id,f.userId)).where(dt(c.id,o)).groupBy(c.id).orderBy(F(c.createdAt))}async getHookGenerationsWithUserData(o,s=50){return await y.select({id:f.id,userId:f.userId,platform:f.platform,objective:f.objective,topic:f.topic,modelType:f.modelType,hooks:f.hooks,topThreeVariants:f.topThreeVariants,createdAt:f.createdAt,user:{id:c.id,email:c.email,firstName:c.firstName,lastName:c.lastName,company:c.company,subscriptionPlan:c.subscriptionPlan,subscriptionStatus:c.subscriptionStatus}}).from(f).innerJoin(c,v(f.userId,c.id)).where(v(f.userId,o)).orderBy(F(f.createdAt)).limit(s)}async getFavoriteHooksWithUserAndGenerationData(o){return await y.select({id:E.id,userId:E.userId,generationId:E.generationId,hook:E.hook,hookData:E.hookData,framework:E.framework,platformNotes:E.platformNotes,topic:E.topic,platform:E.platform,createdAt:E.createdAt,user:{id:c.id,email:c.email,firstName:c.firstName,lastName:c.lastName,company:c.company},generation:{id:f.id,platform:f.platform,topic:f.topic,modelType:f.modelType,createdAt:f.createdAt}}).from(E).innerJoin(c,v(E.userId,c.id)).leftJoin(f,v(E.generationId,f.id)).where(v(E.userId,o)).orderBy(F(E.createdAt))}async getPopularHooksAnalytics(o,s){let t=y.select({platform:f.platform,totalGenerations:oe`COUNT(*)::int`.as("total_generations"),avgScore:oe`AVG((hooks::jsonb->0->>'score')::numeric)::float`.as("avg_score")}).from(f);return o&&s&&(t=t.where(mt(pt(f.createdAt,o),ft(f.createdAt,s)))),await t.groupBy(f.platform).orderBy(F(oe`COUNT(*)`))}lastHealthCheck=null;async healthCheck(){let o=Date.now();if(this.lastHealthCheck&&o-this.lastHealthCheck.timestamp<3e4)return this.lastHealthCheck.result;try{return await y.select().from(c).limit(1),this.lastHealthCheck={result:!0,timestamp:o},!0}catch(s){throw console.error("Database health check failed:",s),this.lastHealthCheck={result:!1,timestamp:o},s}}},g=new _e});import Se from"express";se();Q();import Pt from"express";import{createServer as Tt}from"http";import gt from"openai";if(!process.env.OPENAI_API_KEY&&!process.env.API_KEY)throw new Error("OPENAI_API_KEY or API_KEY environment variable is required");var we=new gt({apiKey:process.env.OPENAI_API_KEY||process.env.API_KEY}),ht={"Question-Based":{"QH-01":{formula:"Direct Question",driver:"Curiosity Gap / Engagement",template:"Did you know that {surprising_fact}?",risk:"low",examples:["Did you know that squats can fix back pain?","Did you know perfect form takes 30 seconds?"]},"QH-02":{formula:"Rhetorical Question",driver:"Pain Point / Empathy",template:"Does your {area_of_life} feel {negative_adjective}?",risk:"low",examples:["Does your squat feel unstable?","Are your workouts feeling ineffective?"]},"QH-03":{formula:"Hypothetical 'What If'",driver:"Imagination / Desire",template:"What if {ideal_scenario}?",risk:"medium",examples:["What if perfect form was actually easier?","What if one cue fixed everything?"]},"QH-04":{formula:"High-Stakes Question",driver:"Intrigue / Moral Dilemma",template:"Would you {action_a} for {benefit} but {consequence}?",risk:"medium",examples:["Would you change your form if it prevented injury?","Would you slow down to speed up progress?"]},"QH-05":{formula:"Challenge Question",driver:"Authority / Knowledge Gap",template:"Why do {authority_figures} still {questionable_action}?",risk:"medium",examples:["Why do trainers still teach this wrong?","Why does everyone skip this step?"]}},"Statement-Based":{"ST-01":{formula:"Direct Promise",driver:"Value / Instant Gratification",template:"In this video, I'm going to show/tell you {specific_value}.",risk:"low",examples:["I'm going to show you perfect squat form","I'll teach you the one cue that fixes everything"]},"ST-02":{formula:"Startling Fact / Statistic",driver:"Surprise / Authority",template:"{percentage}% of people {surprising_behavior}.",risk:"medium",examples:["90% of people squat with poor form","Most trainers miss this critical detail"]},"ST-03":{formula:"Contrarian / Unpopular Opinion",driver:"Social Proof (Negative) / Intrigue",template:"{common_belief} is wrong. Here's why.",risk:"high",examples:["Deep squats are wrong. Here's why.","Heavy weight is overrated. Here's why."]},"ST-04":{formula:"Common Mistake ID",driver:"Pain Point / Superiority",template:"You've been doing {common_activity} wrong your entire life.",risk:"medium",examples:["You've been squatting wrong your entire life","Everyone gets this form cue backwards"]},"ST-05":{formula:"Authority Insight",driver:"Credibility / Exclusivity",template:"{expert_type} taught me this {technique}",risk:"low",examples:["Olympic coaches taught me this squat cue","Physical therapists use this form check"]}},Narrative:{"NA-01":{formula:"In Medias Res",driver:"Curiosity Gap / Urgency",template:"Starts mid-action or mid-dialogue at a point of high drama.",risk:"medium",examples:["The moment my form clicked...","Right when I thought I knew squats..."]},"NA-02":{formula:"Cliffhanger / Open Loop",driver:"Curiosity Gap",template:"This {event} ended in the most shocking way. Stay tuned...",risk:"high",examples:["This form correction changed everything...","What happened next surprised even me..."]},"NA-03":{formula:"Personal Confession / Anecdote",driver:"Empathy / Relatability",template:"I used to {old_behavior}, until {catalyst_for_change}.",risk:"low",examples:["I used to hate squats, until I learned this","I thought perfect form was impossible, until..."]},"NA-04":{formula:"Before & After Teaser",driver:"Curiosity Gap / Transformation",template:"This is how I went from {before_state} to {after_state}.",risk:"low",examples:["From knee pain to pain-free squats","From sloppy form to perfect technique"]},"NA-05":{formula:"Timeline Progression",driver:"Journey / Progress",template:"Day {number} of {challenge}",risk:"low",examples:["Day 7 of fixing my squat form","30 days of perfect form practice"]}},"Urgency/Exclusivity":{"UE-01":{formula:"Direct Callout / Targeting",driver:"Personalization / Relevance",template:"If you're a {target_audience}, you need to hear this.",risk:"medium",examples:["If you squat, you need to hear this","If you're serious about form, watch this"]},"UE-02":{formula:"FOMO / Time Pressure",driver:"Urgency",template:"This is your last chance to {action} before {consequence}.",risk:"high",examples:["Last chance to fix your form before injury","Don't wait until it's too late"]},"UE-03":{formula:"The 'Secret' Reveal",driver:"Curiosity Gap / Exclusivity",template:"No one is telling you the real reason {common_problem_persists}.",risk:"medium",examples:["No one tells you why squats feel awkward","The real reason your form breaks down"]},"UE-04":{formula:"Warning / Preemptive Advice",driver:"Urgency / Pain Avoidance",template:"Watch this before you {common_action}.",risk:"medium",examples:["Watch this before your next squat session","See this before you add more weight"]},"UE-05":{formula:"Insider Access",driver:"Exclusivity / Authority",template:"What {authority_figures} don't want you to know",risk:"high",examples:["What trainers don't teach about form","What gyms don't want you to know"]}},Efficiency:{"EF-01":{formula:"Numbered List (Listicle)",driver:"Value / Structure",template:"Here are the Top {number} {items} for {goal}.",risk:"low",examples:["Top 3 squat cues for perfect form","5 form checks that prevent injury"]},"EF-02":{formula:"Quick Solution / 'Hack'",driver:"Value / Instant Gratification",template:"How to {achieve_goal} in {short_timeframe}.",risk:"low",examples:["Perfect squats in 30 seconds","Fix your form in one video"]},"EF-03":{formula:"Shortcut Reveal",driver:"Efficiency / Simplification",template:"Skip {complex_method}, do this instead",risk:"medium",examples:["Skip complex cues, do this instead","Skip the textbook, watch this"]},"EF-04":{formula:"Elimination Strategy",driver:"Focus / Simplification",template:"Stop {wrong_action}, start {right_action}",risk:"low",examples:["Stop thinking about depth, focus on this","Stop following trends, master basics"]}}};function yt(e,o){return e==="educational"?["Statement-Based","Efficiency","Question-Based"]:e==="storytelling"?["Narrative","Question-Based","Urgency/Exclusivity"]:["Statement-Based","Narrative","Question-Based"]}function _t(e){let o=e.flatMap(s=>{let t=ht[s];return t?Object.entries(t).slice(0,2).map(([r,n])=>({id:r,formula:n.formula,template:n.template,examples:n.examples?.slice(0,2)||[]})):[]});return JSON.stringify(o,null,2)}var ke={tiktok:{wordRange:[8,12],overlayMax:null,requiresElement:"visual_cold_open"},instagram:{wordRange:[6,15],overlayMax:24,requiresElement:"overlay"},youtube:{wordRange:[4,8],overlayMax:null,requiresElement:"proof_cue"}};function vt(e,o){let s=[],t=(e.verbalHook||"").trim().split(/\s+/).length,r=ke[o],[n,i]=r.wordRange;return(t<n||t>i)&&s.push(`Word count ${t} outside ${o} range ${n}-${i}`),/^(if you|stop scrolling|did you know|here's|this is|watch this)/i.test(e.verbalHook||"")&&s.push("Contains overused opening phrase"),o==="instagram"&&e.textualHook&&e.textualHook.length>24&&s.push("Instagram overlay text exceeds 24 characters"),{valid:s.length===0,issues:s,wordCount:t}}async function kt(e,o,s){console.log(`Repairing hook with issues: ${s.join(", ")}`);let t=`Fix this hook for ${o}:
Current hook: "${e.verbalHook}"
Issues: ${s.join(", ")}

Requirements:
- ${o==="tiktok"?"8-12 words":o==="instagram"?"6-15 words":"4-8 words"}
- Avoid clich\xE9d openings (if you, stop scrolling, did you know, here's, this is)
- Keep the same framework and rationale
- Make it engaging and platform-optimized

Return only the improved verbal hook text.`;try{let n=(await we.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"user",content:t}],temperature:.4,max_tokens:100})).choices[0].message.content?.trim();n&&(e.verbalHook=n,e.wordCount=n.split(/\s+/).length)}catch(r){console.error("Hook repair failed:",r)}return e}function Ue(e,o){let s=["how to","tutorial","learn","guide","tips","technique"],t=["story","journey","experience","transformation","challenge"],r=e.toLowerCase(),n=o.toLowerCase(),i=s.some(d=>r.includes(d)||n.includes(d)),a=t.some(d=>r.includes(d)||n.includes(d));return i&&!a?"educational":a&&!i?"storytelling":"mixed"}async function Ee(e,o){let s=(e.verbalHook||"").trim().split(/\s+/).length,t=o.platform,r=2.5,n=0;t==="tiktok"?n=Math.exp(-Math.pow(s-10,2)/8):t==="instagram"?n=Math.exp(-Math.pow(s-10,2)/(2*2.5*2.5)):t==="youtube"&&(n=Math.exp(-Math.pow(s-6,2)/(2*1.5*1.5)));let a={"Open Loop":.8,"Problem-Promise-Proof":.7,"4U's":.6,AIDA:.5,PAS:.5,Direct:.3,Statement:.4,Question:.5}[e.framework]||.4,d=0;t==="tiktok"&&o.objective==="watch_time"?d=e.framework==="Open Loop"?.6:.3:t==="instagram"&&o.objective==="saves"?d=e.framework==="Problem-Promise-Proof"?.5:.2:t==="youtube"&&o.objective==="ctr"&&(d=e.framework==="Question"?.4:.2);let u=Math.min(5,r+n*1.2+a+d+(Math.random()*.3-.15)),_=Math.round(u*10)/10,S=`Word Count: ${Math.round(n*10)/10}, Framework: ${a}, Platform: ${Math.round(d*10)/10} = ${_}/5`;return{...e,wordCount:s,score:_,scoreBreakdown:S,psychologicalDriver:e.psychologicalDriver||"Engagement",hookCategory:e.hookCategory||"Statement-Based",riskFactor:"low",platformNotes:`Optimized for ${o.platform} ${o.objective}`,contentTypeStrategy:Ue(o.topic,o.objective),promiseContentMatch:!0,specificityScore:.7+Math.random()*.2,freshnessScore:.6+Math.random()*.3}}function Et(e){return e.sort((s,t)=>(t.score||0)-(s.score||0)).slice(0,3).map((s,t)=>({...s,variantType:["enhanced","refined","optimized"][t],originalScore:s.score}))}async function Ce(e){console.log("Starting streamlined tri-modal generation with params:",e);let{topic:o,platform:s,objective:t,user:r}=e,n=Ue(o,t),i=yt(n,t),a=_t(i);console.log("Selected taxonomy categories:",i);let d=`You are HookBot, an expert viral video strategist. Generate engaging tri-modal hooks (verbal + visual + textual) optimized for ${s} ${t}.

FOCUS: Generate hooks with minimal fields to ensure reliable JSON parsing.
QUALITY: Use proven psychological frameworks and avoid clich\xE9d openings.
PLATFORM: Optimize for ${s} engagement patterns and constraints.`,u=`### GENERATION REQUEST ###
TOPIC: "${o}"
PLATFORM: ${s} 
OBJECTIVE: ${t}
CONTENT STRATEGY: ${n}

### BRAND CONTEXT ###
Company: ${r.company||"Content Creator"}
Industry: ${r.industry||"General"}
Audience: ${r.audience||"General audience"}
Voice: ${r.voice||"Professional"}

### ALLOWED HOOK CATEGORIES ###
Use only these proven categories and templates:
${a}

### OUTPUT FORMAT ###
Return exactly this JSON structure with 10 hooks:
{
  "hooks": [
    {
      "verbalHook": "Spoken opening line (${ke[s].wordRange[0]}-${ke[s].wordRange[1]} words)",
      "visualHook": "First frame visual suggestion",
      "textualHook": "On-screen text overlay",
      "framework": "Copywriting framework used",
      "rationale": "Why this hook works for the audience"
    }
  ]
}

Generate 10 hooks using diverse frameworks from the allowed categories. Avoid clich\xE9d openings like "If you", "Stop scrolling", "Did you know".`;try{let _=new AbortController,S=setTimeout(()=>{console.log("Generation timed out after 25 seconds"),_.abort()},25e3),A=await we.chat.completions.create({model:"gpt-4o",messages:[{role:"system",content:d},{role:"user",content:u}],response_format:{type:"json_object"},temperature:.8,max_tokens:2500},{signal:_.signal});clearTimeout(S);let x=A.choices[0].message.content;if(!x)throw new Error("No content from streamlined generation");let C=x.trim();C.startsWith("```json")&&(C=C.replace(/^```json\s*/,"").replace(/\s*```$/,"")),C=C.replace(/,(\s*[}\]])/g,"$1");let M;try{M=JSON.parse(C)}catch{return console.error("JSON parsing failed, attempting fallback generation"),await ve(e)}if(!M.hooks||!Array.isArray(M.hooks))return console.error("Invalid hook structure, attempting fallback"),await ve(e);let $=[];for(let K of M.hooks.slice(0,10)){let ie=vt(K,s);if(!ie.valid&&ie.issues.length>0){let Qe=await kt(K,s,ie.issues);$.push(await Ee(Qe,e))}else $.push(await Ee(K,e))}let Je=Et($);return console.log(`Successfully generated ${$.length} validated hooks`),{hooks:$,topThreeVariants:Je}}catch(_){return console.error("Streamlined generation failed:",_),await ve(e)}}async function ve(e){console.log("Using fallback generation");let o=`Generate 10 simple hooks for ${e.platform} about "${e.topic}":
Mix of: Direct value hooks, Question hooks, Transformation hooks, Statement hooks

JSON format: {"hooks": [{"verbalHook": "text", "visualHook": "visual", "textualHook": "overlay", "framework": "Direct", "rationale": "why"}]}`;try{let t=(await we.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"user",content:o}],response_format:{type:"json_object"},temperature:.5,max_tokens:1e3})).choices[0].message.content;if(t){let r=JSON.parse(t),n=[];for(let i of r.hooks||[])n.push(await Ee(i,e));return{hooks:n,topThreeVariants:[]}}}catch(s){console.error("Fallback generation failed:",s)}return wt(e)}function wt(e){return console.log("Using static fallback generation"),{hooks:[{hook:"Here's what you need to know about this",framework:"Direct"},{hook:"This might surprise you about form",framework:"Open Loop"},{hook:"Most people get this wrong",framework:"Statement"},{hook:"Why does everyone struggle with this",framework:"Question"},{hook:"The secret to perfect form",framework:"Statement"},{hook:"Before you try this exercise",framework:"Warning"},{hook:"Transform your workout with this",framework:"Transformation"},{hook:"Nobody talks about this mistake",framework:"Contrarian"},{hook:"Professional trainers use this technique",framework:"Authority"},{hook:"Stop making this common error",framework:"Problem"}].map((t,r)=>({verbalHook:t.hook,visualHook:"Show clear demonstration of the concept",textualHook:"Quick Tutorial",framework:t.framework,psychologicalDriver:"Value",hookCategory:"Statement-Based",riskFactor:"low",score:3+Math.random()*1.5,wordCount:t.hook.split(" ").length,scoreBreakdown:"Static fallback hook",rationale:"Reliable hook pattern for engagement",platformNotes:"Platform-optimized for engagement",contentTypeStrategy:"value_hit",promiseContentMatch:!0,specificityScore:.7,freshnessScore:.6})),topThreeVariants:[]}}import{initializeApp as bt,cert as It,getApps as He}from"firebase-admin/app";import{getAuth as St}from"firebase-admin/auth";if(!He().length&&process.env.FIREBASE_PROJECT_ID)try{console.log("Initializing Firebase Admin SDK..."),process.env.FIREBASE_PROJECT_ID?.includes("@")&&(console.error("ERROR: FIREBASE_PROJECT_ID appears to be a service account email, not a project ID!"),console.error("FIREBASE_PROJECT_ID should be just: hook-line-studio"),console.error("Current value:",process.env.FIREBASE_PROJECT_ID));let e={projectId:process.env.FIREBASE_PROJECT_ID,privateKey:process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g,`
`),clientEmail:process.env.FIREBASE_CLIENT_EMAIL};if(!e.projectId||!e.privateKey||!e.clientEmail)throw new Error("Missing required Firebase credentials");bt({credential:It(e)}),console.log("Firebase Admin SDK initialized successfully")}catch(e){throw console.error("Firebase Admin SDK initialization failed:",e),e}var L=He().length>0?St():null;async function De(e,o=!1){if(!process.env.FIREBASE_PROJECT_ID||!L)throw new Error("Firebase not configured");try{return await L.verifyIdToken(e,o)}catch(s){throw console.error("Error verifying Firebase token:",s),s}}se();function At(e){let o=e.header("authorization")||e.header("Authorization");return o&&o.toLowerCase().startsWith("bearer ")?o.slice(7).trim():e.header("x-firebase-token")?.trim()}async function I(e,o,s){try{let t=At(e);if(!t)return o.status(401).json({message:"No authentication token provided"});let r=await De(t);e.firebaseUser={uid:r.uid,email:r.email,email_verified:r.email_verified,name:r.name,picture:r.picture};try{let n=await g.getUserByFirebaseUid(r.uid);n?e.user={id:n.id,email:n.email||r.email||"",firstName:n.firstName,lastName:n.lastName,company:n.company,industry:n.industry,role:n.role,audience:n.audience,voice:n.voice,bannedTerms:n.bannedTerms,freeCredits:n.freeCredits,usedCredits:n.usedCredits,isPremium:n.isPremium}:e.user={id:r.uid,email:r.email||""}}catch(n){console.warn("Could not fetch user from database:",n),e.user={id:r.uid,email:r.email||""}}s()}catch(t){return String(t?.message||"").includes("expired")?o.status(401).json({message:"Authentication token expired"}):o.status(401).json({message:"Invalid authentication token"})}}import Oe from"express-rate-limit";import Nt from"helmet";var Ge=Oe({windowMs:900*1e3,max:100,message:"Too many requests from this IP, please try again later.",standardHeaders:!0,legacyHeaders:!1}),Fe=Oe({windowMs:60*1e3,max:5,message:"Too many hook generation requests, please wait before trying again.",standardHeaders:!0,legacyHeaders:!1}),Le=(e,o,s)=>{if(e.body){let t=n=>typeof n!="string"?n:n.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/javascript:/gi,"").replace(/on\w+\s*=/gi,"").trim(),r=n=>{if(typeof n=="string")return t(n);if(Array.isArray(n))return n.map(r);if(n&&typeof n=="object"){let i={};for(let a in n)i[a]=r(n[a]);return i}return n};e.body=r(e.body)}s()},je=Nt({contentSecurityPolicy:!0,crossOriginEmbedderPolicy:!1,hsts:{maxAge:31536e3,includeSubDomains:!0,preload:!0}}),Be=(e,o,s)=>{let t=e.get("Content-Length");if(t&&parseInt(t)>1048576)return o.status(413).json({error:"Request too large"});s()};ye();import Rt from"stripe";var xt=new Rt(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-06-30.basil"});async function Me(e){return e.set("trust proxy",1),e.use(je),e.use(Be),e.use(Le),e.use("/api/",Ge),e.post("/api/auth/register",async(s,t)=>{try{let r=ce.safeParse(s.body);if(!r.success)return t.status(400).json({message:"Invalid input data",errors:r.error.issues.map(u=>({field:u.path.join("."),message:u.message}))});let{email:n,password:i,firstName:a,lastName:d}=r.data;try{let u=await L.createUser({email:n,password:i,displayName:`${a} ${d}`,emailVerified:!1}),_=await L.createCustomToken(u.uid),S={id:u.uid,email:u.email||n,firstName:a,lastName:d,company:"",industry:"",role:"",audience:"",voice:"",bannedTerms:[],safetyPreferences:{avoidControversy:!0,familyFriendly:!0,brandSafe:!0},freeCredits:5,usedCredits:0,isPremium:!1,subscriptionStatus:"free",subscriptionPlan:null,currentPeriodEnd:null,cancelAtPeriodEnd:!1,stripeCustomerId:null,stripeSubscriptionId:null};try{await g.upsertUser(S)}catch(A){console.log("Database user creation error (possibly duplicate):",A.message)}t.json({success:!0,customToken:_,user:{uid:u.uid,email:u.email,displayName:u.displayName,emailVerified:u.emailVerified}})}catch(u){return console.error("Firebase Admin registration error:",u),u.code==="auth/email-already-exists"?t.status(400).json({message:"An account with this email already exists"}):t.status(400).json({message:"Registration failed: "+u.message})}}catch(r){console.error("Registration error:",r),t.status(500).json({message:"Internal server error during registration"})}}),e.post("/api/auth/login",async(s,t)=>{try{let r=ue.safeParse(s.body);if(!r.success)return t.status(400).json({message:"Invalid input data",errors:r.error.issues.map(a=>({field:a.path.join("."),message:a.message}))});let{email:n,password:i}=r.data;try{let a=await L.getUserByEmail(n),d=await L.createCustomToken(a.uid);t.json({success:!0,customToken:d,user:{uid:a.uid,email:a.email,displayName:a.displayName,emailVerified:a.emailVerified}})}catch(a){return console.error("Firebase Admin login error:",a),a.code==="auth/user-not-found"?t.status(401).json({message:"Invalid email or password"}):t.status(401).json({message:"Login failed: "+a.message})}}catch(r){console.error("Login error:",r),t.status(500).json({message:"Internal server error during login"})}}),e.post("/api/auth/firebase-sync",I,async(s,t)=>{try{let r=s.firebaseUser;if(!r||!r.uid||!r.email)return t.status(401).json({message:"Invalid Firebase authentication"});let n=await g.getUser(r.uid),i=!1;if(n)n=await g.getUser(r.uid);else{i=!0;let d={id:r.uid,email:r.email,firstName:r.name?.split(" ")[0]||"",lastName:r.name?.split(" ").slice(1).join(" ")||"",company:"",industry:"",role:"",audience:"",voice:"",bannedTerms:[],safetyPreferences:{avoidControversy:!0,familyFriendly:!0,brandSafe:!0},freeCredits:5,usedCredits:0,isPremium:!1,subscriptionStatus:"free",subscriptionPlan:null,currentPeriodEnd:null,cancelAtPeriodEnd:!1,stripeCustomerId:null,stripeSubscriptionId:null};n=await g.upsertUser(d)}if(!n)throw new Error("Failed to create or retrieve user");let a=!n.company?.trim()||!n.industry?.trim()||!n.role?.trim()||!n.audience?.trim()||!n.voice?.trim();console.log("Firebase sync check:",{userId:r.uid,company:n.company,industry:n.industry,role:n.role,audience:n.audience,voice:n.voice,needsOnboarding:a}),t.json({success:!0,user:n,isNewUser:i,needsOnboarding:a})}catch(r){console.error("Firebase sync error:",r),t.status(500).json({message:"Failed to sync user data"})}}),e.post("/api/users",I,async(s,t)=>{try{let r=s.firebaseUser?.uid;if(!r)return t.status(401).json({message:"Authentication required"});console.log("Creating/updating user profile for:",r);let n={...s.body,email:s.user?.email||s.firebaseUser?.email||"",id:r},i=J.parse(n),a=await g.updateUser(r,i);if(!a)return t.status(404).json({message:"User not found"});t.json(a)}catch(r){console.error("Error creating/updating user:",r),t.status(400).json({message:"Invalid user data",error:r instanceof Error?r.message:"Unknown error"})}}),e.get("/api/users/me",I,async(s,t)=>{try{let r=s.firebaseUser?.uid;if(!r)return t.status(401).json({message:"Authentication required"});let n=await g.getUser(r);if(!n)return t.status(404).json({message:"User not found"});t.json(n)}catch(r){t.status(500).json({message:"Failed to fetch user",error:r instanceof Error?r.message:"Unknown error"})}}),e.put("/api/users/me",I,async(s,t)=>{try{let r=s.firebaseUser?.uid;if(!r)return t.status(401).json({message:"Authentication required"});let n=J.partial().parse(s.body),i=await g.updateUser(r,n);if(!i)return t.status(404).json({message:"User not found"});t.json(i)}catch(r){t.status(400).json({message:"Invalid user data",error:r instanceof Error?r.message:"Unknown error"})}}),e.get("/api/credits/check",I,async(s,t)=>{try{let r=s.user?.id;if(!r)return t.status(401).json({message:"Authentication required"});let n=await g.checkUserCanGenerate(r);t.json(n)}catch(r){console.error("Error checking credits:",r),t.status(500).json({error:"Failed to check credits"})}}),e.get("/api/generations/status",I,async(s,t)=>{try{let r=s.user?.id;if(!r)return t.status(401).json({message:"Authentication required"});let n=s.query.modelType||"gpt-4o",i=await g.checkUserCanGenerateWithModel(r,n);t.json(i)}catch(r){console.error("Error checking generation status:",r),t.status(500).json({error:"Failed to check generation status"})}}),e.post("/api/generate-hooks",Fe,I,async(s,t)=>{try{let r=s.user?.id;if(!r)return t.status(401).json({message:"Authentication required"});let{platform:n,objective:i,topic:a,modelType:d}=s.body;if(!n||!i||!a)return t.status(400).json({message:"Missing required fields: platform, objective, topic"});let u=await g.getUser(r);if(!u)return t.status(404).json({message:"User not found"});if(d||((u.subscriptionPlan||"free")==="free"?d="gpt-4o-mini":d="gpt-4o"),!["gpt-4o","gpt-4o-mini"].includes(d))return t.status(400).json({message:"Invalid model type. Must be 'gpt-4o' or 'gpt-4o-mini'"});(u.subscriptionPlan||"free")==="free"&&d==="gpt-4o"&&(d="gpt-4o-mini",console.log("Free user attempted to use gpt-4o, automatically switched to gpt-4o-mini")),console.log(`Final model selection: ${d} for user plan: ${u.subscriptionPlan||"free"}`);let _=await g.checkUserCanGenerateWithModel(r,d);if(!_.canGenerate)return t.status(403).json({error:_.reason||"Generation limit reached",remainingProGenerations:_.remainingProGenerations,remainingDraftGenerations:_.remainingDraftGenerations,isAtLimit:!0});console.log(`Generating tri-modal hooks for ${n} with topic: "${a}"`),console.log(`User profile: ${u.company} (${u.industry}, ${u.role})`),console.log(`Audience: ${u.audience?.substring(0,100)}...`);let S=await Ce({topic:a,platform:n,objective:i,modelType:d,company:u.company||"Unknown Company",role:u.role||"Creator",industry:u.industry||"General",audience:u.audience||"General Audience",voice:u.voice||"Friendly",bannedTerms:u.bannedTerms||[],safety:"standard"}),A=await g.createHookGeneration({userId:r,platform:n,objective:i,topic:a,modelType:d,hooks:S.hooks,topThreeVariants:S.topThreeVariants});await g.incrementUserGenerations(r,d),t.json(A)}catch(r){console.error("Hook generation error:",r),t.status(500).json({message:"Failed to generate hooks",error:r instanceof Error?r.message:"Unknown error"})}}),e.get("/api/generations",I,async(s,t)=>{try{let r=s.user?.id;if(!r)return t.status(401).json({message:"Authentication required"});let n=await g.getHookGenerationsByUser(r);t.json(n)}catch(r){t.status(500).json({message:"Failed to fetch generations",error:r instanceof Error?r.message:"Unknown error"})}}),e.get("/api/generation/:id",async(s,t)=>{try{let r=await g.getHookGeneration(s.params.id);if(!r)return t.status(404).json({message:"Generation not found"});t.json(r)}catch(r){t.status(500).json({message:"Failed to fetch generation",error:r instanceof Error?r.message:"Unknown error"})}}),e.post("/api/favorites",I,async(s,t)=>{try{let r=s.user?.id;if(!r)return t.status(401).json({message:"Authentication required"});console.log("Received favorite data:",s.body);let n=le.parse({...s.body,userId:r});console.log("Parsed favorite data:",n);let i=await g.createFavoriteHook(n);n.hook&&await g.addRecentHook({userId:r,hook:n.hook}),t.json(i)}catch(r){console.error("Favorite creation error:",r),t.status(400).json({message:"Invalid favorite data",error:r instanceof Error?r.message:"Unknown error"})}}),e.get("/api/favorites",I,async(s,t)=>{try{let r=s.user?.id;if(!r)return t.status(401).json({message:"Authentication required"});let n=await g.getFavoriteHooksByUser(r);t.json(n)}catch(r){t.status(500).json({message:"Failed to fetch favorites",error:r instanceof Error?r.message:"Unknown error"})}}),e.delete("/api/favorites/:id",I,async(s,t)=>{try{if(!await g.deleteFavoriteHook(s.params.id))return t.status(404).json({message:"Favorite not found"});t.json({message:"Favorite deleted successfully"})}catch(r){t.status(500).json({message:"Failed to delete favorite",error:r instanceof Error?r.message:"Unknown error"})}}),e.post("/api/export-csv",I,async(s,t)=>{try{let{generationId:r}=s.body;if(!r)return t.status(400).json({message:"Generation ID is required"});let n=await g.getHookGeneration(r);if(!n)return t.status(404).json({message:"Generation not found"});let i=`Hook,Framework,Rationale,Platform Notes,Score,Word Count
`,a=n.hooks.map(u=>`"${u.verbalHook}","${u.framework}","${u.rationale}","${u.platformNotes}",${u.score},${u.wordCount}`).join(`
`),d=i+a;t.setHeader("Content-Type","text/csv"),t.setHeader("Content-Disposition",`attachment; filename="hooks-${n.platform}-${Date.now()}.csv"`),t.send(d)}catch(r){t.status(500).json({message:"Failed to export CSV",error:r instanceof Error?r.message:"Unknown error"})}}),e.delete("/api/generations/:generationId",I,async(s,t)=>{try{let{generationId:r}=s.params,n=s.user?.id;if(!n)return t.status(401).json({message:"Authentication required"});let i=await g.getGenerationById(r);if(!i||i.userId!==n)return t.status(404).json({message:"Generation not found"});await g.deleteGeneration(r),t.json({message:"Generation deleted successfully"})}catch(r){console.error("Error deleting generation:",r),t.status(500).json({message:"Failed to delete generation"})}}),e.get("/api/stripe/plans",(s,t)=>{t.json({plans:re})}),e.post("/api/stripe/create-subscription",I,async(s,t)=>{try{let r=s.user?.id;if(!r)return t.status(401).json({message:"Authentication required"});let n=await g.getUser(r);if(!n?.email)return t.status(400).json({message:"User email not found"});let{plan:i,promotionCode:a}=s.body;if(!i||!["starter","creator","pro","teams"].includes(i.toLowerCase()))return t.status(400).json({message:"Invalid plan. Must be 'starter', 'creator', 'pro', or 'teams'"});let d=i.toUpperCase(),u=re[d].priceId;if(!u)return t.status(400).json({message:"Price ID not configured for this plan"});let _=await me(r,n.email,u,a);await g.updateUser(r,{subscriptionPlan:i.toLowerCase(),subscriptionStatus:"trialing"}),t.json(_)}catch(r){console.error("Error creating subscription:",r),t.status(500).json({message:"Failed to create subscription",error:r instanceof Error?r.message:"Unknown error"})}}),e.get("/api/stripe/subscription",I,async(s,t)=>{try{let r=s.user?.id;if(!r)return t.status(401).json({message:"Authentication required"});let n=await g.getUser(r);if(!n?.stripeSubscriptionId)return t.status(404).json({message:"No subscription found"});let i=await fe(n.stripeSubscriptionId);t.json(i)}catch(r){console.error("Error fetching subscription:",r),t.status(500).json({message:"Failed to fetch subscription",error:r instanceof Error?r.message:"Unknown error"})}}),e.post("/api/stripe/portal",I,async(s,t)=>{try{let r=s.user?.id;if(!r)return t.status(401).json({message:"Authentication required"});let n=await g.getUser(r),{returnUrl:i}=s.body;if(!n?.stripeCustomerId)return t.status(400).json({message:"No Stripe customer found"});let a=await pe(n.stripeCustomerId,i||`${s.protocol}://${s.get("host")}/app`);t.json({url:a})}catch(r){console.error("Error creating portal session:",r),t.status(500).json({message:"Failed to create portal session",error:r instanceof Error?r.message:"Unknown error"})}}),e.post("/api/stripe/cancel",I,async(s,t)=>{try{let r=s.user?.id;if(!r)return t.status(401).json({message:"Authentication required"});let n=await g.getUser(r);if(!n?.stripeSubscriptionId)return t.status(404).json({message:"No active subscription found"});await ge(n.stripeSubscriptionId),await g.updateUser(r,{cancelAtPeriodEnd:!0}),t.json({message:"Subscription will be canceled at the end of the billing period"})}catch(r){console.error("Error cancelling subscription:",r),t.status(500).json({message:"Failed to cancel subscription",error:r instanceof Error?r.message:"Unknown error"})}}),e.post("/api/stripe/webhook",Pt.raw({type:"application/json"}),async(s,t)=>{let r=s.headers["stripe-signature"],n=process.env.STRIPE_WEBHOOK_SECRET;if(!n)return console.error("Stripe webhook secret not configured"),t.status(500).json({error:"Server configuration error"});try{let i=xt.webhooks.constructEvent(s.body,r,n);await he(i),t.json({received:!0})}catch(i){console.error("Webhook signature verification failed:",i),t.status(400).json({error:"Invalid webhook signature"})}}),Tt(e)}import Ht from"express";import Ve from"fs";import be from"path";import{createServer as Dt,createLogger as Ot}from"vite";import{defineConfig as Ut}from"vite";import Ct from"@vitejs/plugin-react";import V from"path";var $e=Ut({plugins:[Ct()],resolve:{alias:{"@":V.resolve(import.meta.dirname,"client","src"),"@shared":V.resolve(import.meta.dirname,"shared"),"@assets":V.resolve(import.meta.dirname,"attached_assets")}},root:V.resolve(import.meta.dirname,"client"),build:{outDir:V.resolve(import.meta.dirname,"dist/public"),emptyOutDir:!0,target:"es2020",minify:"esbuild",sourcemap:!1,rollupOptions:{output:{manualChunks:e=>{if(e.includes("react")||e.includes("react-dom"))return"react-vendor";if(e.includes("/components/ConversionHero")||e.includes("/components/InteractiveCTA")||e.includes("/components/TrustSignals")||e.includes("/components/UrgencyIndicators")||e.includes("/components/StickyMicroCTA")||e.includes("/components/CTABand"))return"conversion-components";if(e.includes("/hooks/useConversionTracking")||e.includes("/lib/analytics")||e.includes("/types/analytics")||e.includes("/types/conversion"))return"analytics";if(e.includes("@radix-ui/")||e.includes("/components/ui/"))return"ui-library";if(e.includes("clsx")||e.includes("tailwind-merge")||e.includes("date-fns")||e.includes("framer-motion"))return"utilities";if(e.includes("@tanstack/react-query")||e.includes("wouter")||e.includes("zustand"))return"state-management";if(e.includes("firebase")||e.includes("auth"))return"firebase";if(e.includes("node_modules"))return"vendor"},assetFileNames:e=>{let o=e.name?.split(".")||[],s=o[o.length-1];return/png|jpe?g|svg|gif|tiff|bmp|ico/i.test(s)?"assets/images/[name]-[hash][extname]":/css/i.test(s)?"assets/css/[name]-[hash][extname]":"assets/[name]-[hash][extname]"},chunkFileNames:"assets/js/[name]-[hash].js",entryFileNames:"assets/js/[name]-[hash].js"},external:[],treeshake:{moduleSideEffects:!1,propertyReadSideEffects:!1,unknownGlobalSideEffects:!1}},chunkSizeWarningLimit:1e3,assetsInlineLimit:4096,cssCodeSplit:!0,reportCompressedSize:!1,write:!0},server:{fs:{strict:!0,deny:["**/.*"]}}});import{nanoid as Gt}from"nanoid";var qe=Ot();async function We(e,o){let s={middlewareMode:!0,hmr:{server:o},allowedHosts:!0},t=await Dt({...$e,configFile:!1,customLogger:{...qe,error:(r,n)=>{qe.error(r,n),process.exit(1)}},server:s,appType:"custom"});e.use(t.middlewares),e.use("*",async(r,n,i)=>{let a=r.originalUrl;try{let d=be.resolve(import.meta.dirname,"..","client","index.html"),u=await Ve.promises.readFile(d,"utf-8");u=u.replace('src="/src/main.tsx"',`src="/src/main.tsx?v=${Gt()}"`);let _=await t.transformIndexHtml(a,u);n.status(200).set({"Content-Type":"text/html"}).end(_)}catch(d){t.ssrFixStacktrace(d),i(d)}})}function Ke(e){let o=be.resolve(import.meta.dirname,"public");if(!Ve.existsSync(o))throw new Error(`Could not find the build directory: ${o}, make sure to build the client first`);e.use(Ht.static(o,{maxAge:"1y",etag:!0,lastModified:!0,setHeaders:(s,t)=>{t.endsWith(".html")&&(s.setHeader("Cache-Control","no-cache, no-store, must-revalidate"),s.setHeader("Pragma","no-cache"),s.setHeader("Expires","0")),s.setHeader("X-Content-Type-Options","nosniff"),s.setHeader("X-Frame-Options","DENY")}})),e.use("*",(s,t)=>{t.setHeader("Cache-Control","no-cache, no-store, must-revalidate"),t.setHeader("Pragma","no-cache"),t.setHeader("Expires","0"),t.sendFile(be.resolve(o,"index.html"))})}function Ye(e,o,s){o.setHeader("Strict-Transport-Security","max-age=31536000; includeSubDomains; preload"),o.setHeader("Content-Security-Policy",["default-src 'self'","script-src 'self' 'unsafe-inline' https://js.stripe.com https://maps.googleapis.com https://www.gstatic.com","style-src 'self' 'unsafe-inline' https://fonts.googleapis.com","font-src 'self' https://fonts.gstatic.com","img-src 'self' data: https:","connect-src 'self' https://api.stripe.com https://api.openai.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://hook-line-studio-default-rtdb.firebaseio.com https://firebaseinstallations.googleapis.com","frame-src https://js.stripe.com https://hooks.stripe.com","form-action 'self'","base-uri 'self'","object-src 'none'"].join("; ")),o.setHeader("X-Frame-Options","DENY"),o.setHeader("X-Content-Type-Options","nosniff"),o.setHeader("Referrer-Policy","strict-origin-when-cross-origin"),o.setHeader("Permissions-Policy",["camera=()","microphone=()","geolocation=()","payment=(self)"].join(", ")),o.setHeader("X-XSS-Protection","1; mode=block"),o.removeHeader("X-Powered-By"),s()}function ze(e,o,s){if(!e.secure&&e.get("X-Forwarded-Proto")!=="https")return o.redirect(301,`https://${e.get("Host")}${e.url}`);s()}import{z as l}from"zod";var Ft=l.object({NODE_ENV:l.enum(["development","production","test"]).default("development"),PORT:l.string().transform(Number).pipe(l.number().min(1).max(65535)).default("5000"),DATABASE_URL:l.string().url("DATABASE_URL must be a valid PostgreSQL connection string"),FIREBASE_PROJECT_ID:l.string().min(1,"FIREBASE_PROJECT_ID is required"),FIREBASE_CLIENT_EMAIL:l.string().email("FIREBASE_CLIENT_EMAIL must be a valid email"),FIREBASE_PRIVATE_KEY:l.string().min(1,"FIREBASE_PRIVATE_KEY is required"),OPENAI_API_KEY:l.string().min(1,"OPENAI_API_KEY is required"),STRIPE_SECRET_KEY:l.string().min(1,"STRIPE_SECRET_KEY is required"),STRIPE_WEBHOOK_SECRET:l.string().min(1,"STRIPE_WEBHOOK_SECRET is required"),ANALYTICS_ENABLED:l.string().transform(Boolean).default("true"),ANALYTICS_BATCH_SIZE:l.string().transform(Number).pipe(l.number().min(1).max(1e3)).default("100"),ANALYTICS_FLUSH_INTERVAL:l.string().transform(Number).pipe(l.number().min(1e3)).default("10000"),ANALYTICS_SAMPLING_RATE:l.string().transform(Number).pipe(l.number().min(0).max(1)).default("1.0"),AB_TESTING_ENABLED:l.string().transform(Boolean).default("true"),AB_TESTING_DEFAULT_TRAFFIC:l.string().transform(Number).pipe(l.number().min(0).max(1)).default("1.0"),AB_TESTING_MIN_SAMPLE_SIZE:l.string().transform(Number).pipe(l.number().min(10)).default("100"),CONVERSION_TRACKING_ENABLED:l.string().transform(Boolean).default("true"),CONVERSION_API_ENDPOINT:l.string().default("/api/analytics/track"),CONVERSION_RETENTION_DAYS:l.string().transform(Number).pipe(l.number().min(1).max(365)).default("90"),GDPR_COMPLIANCE_ENABLED:l.string().transform(Boolean).default("true"),CCPA_COMPLIANCE_ENABLED:l.string().transform(Boolean).default("true"),ANONYMIZE_IPS:l.string().transform(Boolean).default("true"),DATA_RETENTION_DAYS:l.string().transform(Number).pipe(l.number().min(30).max(2555)).default("730"),ENABLE_COMPRESSION:l.string().transform(Boolean).default("true"),CACHE_MAX_AGE:l.string().transform(Number).pipe(l.number().min(0)).default("86400"),CDN_CACHE_CONTROL:l.string().default("public, max-age=31536000, immutable"),ANALYTICS_RATE_LIMIT_REQUESTS:l.string().transform(Number).pipe(l.number().min(1)).default("1000"),ANALYTICS_RATE_LIMIT_WINDOW:l.string().transform(Number).pipe(l.number().min(60)).default("900"),ENABLE_PERFORMANCE_MONITORING:l.string().transform(Boolean).default("true"),PERFORMANCE_THRESHOLD_P95:l.string().transform(Number).pipe(l.number().min(100)).default("500"),ERROR_RATE_THRESHOLD:l.string().transform(Number).pipe(l.number().min(0).max(1)).default("0.05"),GOOGLE_ANALYTICS_MEASUREMENT_ID:l.string().optional(),MIXPANEL_PROJECT_TOKEN:l.string().optional(),SEGMENT_WRITE_KEY:l.string().optional(),REPL_ID:l.string().optional(),RAILWAY_ENVIRONMENT:l.string().optional(),RAILWAY_PROJECT_ID:l.string().optional(),RAILWAY_SERVICE_ID:l.string().optional(),LOG_LEVEL:l.enum(["error","warn","info","debug"]).default("info"),ENABLE_REQUEST_LOGGING:l.string().transform(Boolean).default("true")}),j;function ne(){if(j)return j;try{return j=Ft.parse(process.env),j.NODE_ENV==="development"&&console.log("\u2705 Environment variables validated successfully"),j}catch(e){if(e instanceof l.ZodError){let o=e.errors.map(s=>`${s.path.join(".")}: ${s.message}`);throw console.error("\u274C Environment validation failed:"),o.forEach(s=>console.error(`  - ${s}`)),console.error("\u{1F6A8} Cannot start server with invalid environment configuration"),process.exit(1),new Error(`Environment validation failed: ${o.join(", ")}`)}throw e}}function B(){return j||ne()}function W(){return B().NODE_ENV==="production"}ne();var Ie=class{env=B();service="hook-line-studio";createLogEntry(o,s,t,r){let n={level:o,message:s,timestamp:new Date().toISOString(),environment:this.env.NODE_ENV,service:this.service};return t&&(n.data=t),r&&(n.error={name:r.name,message:r.message,stack:W()?void 0:r.stack}),n}shouldLog(o){let s=["error","warn","info","debug"],t=s.indexOf(this.env.LOG_LEVEL);return s.indexOf(o)<=t}output(o){if(this.shouldLog(o.level))if(W())console.log(JSON.stringify(o));else{let t=`[${new Date(o.timestamp).toLocaleTimeString()}] ${o.level.toUpperCase()}:`;if(o.error)console.log(`${t} ${o.message}`),console.error(o.error.stack||o.error.message),o.data&&console.log("Data:",o.data);else{let r=o.data?` ${JSON.stringify(o.data)}`:"";console.log(`${t} ${o.message}${r}`)}}}error(o,s,t){this.output(this.createLogEntry("error",o,t,s))}warn(o,s){this.output(this.createLogEntry("warn",o,s))}info(o,s){this.output(this.createLogEntry("info",o,s))}debug(o,s){this.output(this.createLogEntry("debug",o,s))}logRequest(o,s,t){let r=s.statusCode,n=r>=500?"error":r>=400?"warn":"info";this.output(this.createLogEntry(n,"HTTP Request",{method:o.method,path:o.path,statusCode:r,duration:`${t}ms`,ip:o.ip||o.connection?.remoteAddress,userAgent:o.get?.("User-Agent")?.substring(0,100),userId:o.user?.id||o.firebaseUser?.uid}))}logDatabase(o,s,t,r){r?this.error(`Database ${o} failed`,r,{table:s,duration:t}):this.debug(`Database ${o}`,{table:s,duration:t})}logExternalAPI(o,s,t,r){r?this.error(`${o} API call failed`,r,{operation:s,duration:t}):this.info(`${o} API call`,{operation:s,duration:t})}},N=new Ie;te();import Lt from"connect-history-api-fallback";ne();var T=Se();T.get("/health",async(e,o)=>{let s=Date.now(),t=B(),r={status:"healthy",timestamp:new Date().toISOString(),environment:t.NODE_ENV,uptime:process.uptime(),version:process.env.npm_package_version||"1.0.0",services:{database:"unknown",firebase:t.FIREBASE_PROJECT_ID?"configured":"not_configured",stripe:t.STRIPE_SECRET_KEY?"configured":"not_configured",openai:t.OPENAI_API_KEY?"configured":"not_configured",analytics:t.ANALYTICS_ENABLED?"enabled":"disabled",abTesting:t.AB_TESTING_ENABLED?"enabled":"disabled"},conversion:{tracking:t.CONVERSION_TRACKING_ENABLED,privacy:{gdpr:t.GDPR_COMPLIANCE_ENABLED,ccpa:t.CCPA_COMPLIANCE_ENABLED,anonymizeIps:t.ANONYMIZE_IPS},performance:{monitoring:t.ENABLE_PERFORMANCE_MONITORING,threshold:`${t.PERFORMANCE_THRESHOLD_P95}ms`,errorThreshold:`${(t.ERROR_RATE_THRESHOLD*100).toFixed(1)}%`}},checks:{memory:{used:Math.round(process.memoryUsage().heapUsed/1024/1024),free:Math.round(process.memoryUsage().heapTotal/1024/1024),total:Math.round(process.memoryUsage().rss/1024/1024)}}};try{let{pool:i}=await Promise.resolve().then(()=>(te(),Te)),a=i.query("SELECT 1 as health_check"),d=new Promise((u,_)=>setTimeout(()=>_(new Error("Database timeout")),3e3));await Promise.race([a,d]),r.services.database="connected";try{let u=i.query(`
        SELECT table_name 
        FROM information_schema.tables 
        WHERE table_schema = 'public' 
        AND table_name IN ('analytics_events', 'ab_tests', 'conversion_funnels', 'user_consent')
      `),_=await Promise.race([u,new Promise((S,A)=>setTimeout(()=>A(new Error("Conversion tables check timeout")),2e3))]);r.conversion={...r.conversion,tablesReady:_.rows.length===4}}catch(u){N.warn("Conversion tables check failed:",u),r.conversion={...r.conversion,tablesReady:!1}}}catch(i){N.error("Health check database error:",i),r.services.database="disconnected"}let n=Date.now()-s;r.checks={...r.checks,responseTime:`${n}ms`},o.status(200).json(r)});T.get("/ready",(e,o)=>{o.status(200).json({status:"ready",timestamp:new Date().toISOString(),uptime:process.uptime()})});T.get("/live",(e,o)=>{o.status(200).json({status:"alive",timestamp:new Date().toISOString(),uptime:process.uptime(),environment:"production",railway:process.env.RAILWAY_ENVIRONMENT||"local"})});T.use(ze);T.use(Ye);T.use(Se.json());T.use(Se.urlencoded({extended:!1}));T.use((e,o,s)=>{if(!B().ENABLE_REQUEST_LOGGING)return s();let t=Date.now();o.on("finish",()=>{let r=Date.now()-t;(e.path.startsWith("/api")||o.statusCode>=400)&&N.logRequest(e,o,r)}),s()});(async()=>{try{N.info("Starting application server...");let e=await Me(T);T.use((n,i,a,d)=>{let u=n.status||n.statusCode||500,_=n.message||"Internal Server Error";N.error(`HTTP Error ${u}`,n),a.status(u).json({message:_})}),T.get("env")==="development"?await We(T,e):(T.use(Lt({disableDotRule:!0,htmlAcceptHeaders:["text/html","application/xhtml+xml"]})),Ke(T));let o=B(),s=o.PORT,t=e.listen({port:s,host:"0.0.0.0",reusePort:!0},()=>{N.info("Server started",{port:s,environment:o.NODE_ENV,railway:o.RAILWAY_ENVIRONMENT||"local",healthCheck:"/live",readinessCheck:"/ready"})}),r=n=>{N.warn(`Received ${n}. Starting graceful shutdown...`),t.close(a=>{a&&(N.error("Error during server shutdown",a),process.exit(1)),N.info("Server closed successfully"),typeof q?.end=="function"?q.end().then(()=>{N.info("Database connections closed"),process.exit(0)}).catch(d=>{N.error("Error closing database connections",d),process.exit(1)}):process.exit(0)});let i=o.RAILWAY_ENVIRONMENT?25e3:3e4;setTimeout(()=>{N.error(`Forced shutdown after ${i/1e3} seconds`),process.exit(1)},i)};process.on("SIGTERM",()=>r("SIGTERM")),process.on("SIGINT",()=>r("SIGINT")),W()&&(process.on("uncaughtException",n=>{N.error("Uncaught Exception",n),r("UNCAUGHT_EXCEPTION")}),process.on("unhandledRejection",(n,i)=>{N.error("Unhandled Rejection",n instanceof Error?n:new Error(String(n)),{promise:String(i)}),r("UNHANDLED_REJECTION")}))}catch(e){N.error("Failed to start server",e instanceof Error?e:new Error(String(e))),process.exit(1)}})();
//# sourceMappingURL=index.js.map
